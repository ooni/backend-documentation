<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Backend documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_backend_documentation">Backend documentation</a>
<ul class="sectlevel2">
<li><a href="#_progress_report_to_be_deleted_when_finished">Progress report (to be deleted when finished)</a></li>
<li><a href="#_glossary">Glossary</a></li>
</ul>
</li>
<li><a href="#_architecture">Architecture</a></li>
<li><a href="#_main_data_flows">Main data flows</a></li>
<li><a href="#_conventions">Conventions</a></li>
<li><a href="#_application_metrics">Application metrics</a>
<ul class="sectlevel2">
<li><a href="#tool:prometheus">Prometheus</a></li>
<li><a href="#topic:dashboards">Grafana dashboards</a></li>
</ul>
</li>
<li><a href="#logman">Log management</a></li>
<li><a href="#sys_timers">Systemd timers</a></li>
<li><a href="#_summary_of_timers">Summary of timers</a>
<ul class="sectlevel2">
<li><a href="#_dehydrated_timer">Dehydrated timer</a></li>
<li><a href="#timer:detector">Detector timer</a></li>
<li><a href="#timer:uploader">ooni-api-uploader timer</a></li>
<li><a href="#timer:db_backup">ooni-db-backup timer</a></li>
<li><a href="#timer:geoip">ooni-download-geoip timer</a></li>
<li><a href="#timer:rotation">ooni-rotation timer</a></li>
<li><a href="#_ooni_update_asn_metadata_timer_timer">ooni-update-asn-metadata timer [[timer:</a></li>
<li><a href="#timer:citizenlab">ooni-update-citizenlab</a></li>
<li><a href="#_ooni_update_fingerprints">ooni-update-fingerprints</a></li>
</ul>
</li>
<li><a href="#comp:api">API</a>
<ul class="sectlevel2">
<li><a href="#_measurements">Measurements</a></li>
<li><a href="#comp:mat">MAT</a></li>
<li><a href="#_probe_services">Probe services</a></li>
<li><a href="#_private_entry_points">Private entry points</a></li>
<li><a href="#_codebase">Codebase</a></li>
<li><a href="#_tor_targets">Tor targets</a></li>
</ul>
</li>
<li><a href="#comp:fastpath">Fastpath</a></li>
<li><a href="#comp:test-helpers">Test helpers</a>
<ul class="sectlevel2">
<li><a href="#_fastpath_codebase">Fastpath codebase</a></li>
<li><a href="#comp:analysis">Analysis</a></li>
<li><a href="#detector">Social media blocking event detector</a></li>
<li><a href="#comp:ooni-bridges">OONI bridges</a></li>
<li><a href="#rotation">Test helper rotation</a></li>
</ul>
</li>
<li><a href="#_misc_scripts">Misc scripts</a></li>
<li><a href="#_database">Database</a></li>
<li><a href="#_hosts">Hosts</a>
<ul class="sectlevel2">
<li><a href="#host:FSN">backend-fsn.ooni.org</a></li>
<li><a href="#host:HEL">backend-hel.ooni.org</a></li>
<li><a href="#host:test">ams-pg-test.ooni.org</a></li>
<li><a href="#host:monitoring">monitoring.ooni.org</a></li>
</ul>
</li>
<li><a href="#_infrastructure">Infrastructure</a>
<ul class="sectlevel2">
<li><a href="#_the_sysadmin_repository">The Sysadmin repository</a></li>
<li><a href="#tool:ansible">Ansible</a></li>
<li><a href="#tool:etckeeper">Etckeeper</a></li>
<li><a href="#_team_credential_repository">Team credential repository</a></li>
<li><a href="#_new_host_howto">New host HOWTO</a></li>
</ul>
</li>
<li><a href="#dns">DNS and Domains</a>
<ul class="sectlevel2">
<li><a href="#dnspol">DNS naming policy</a></li>
<li><a href="#_dns_diagrams">DNS diagrams</a></li>
</ul>
</li>
<li><a href="#_operations">Operations</a>
<ul class="sectlevel2">
<li><a href="#_build_deploy_rollback">Build, deploy, rollback</a></li>
<li><a href="#deployer">The deployer tool</a></li>
<li><a href="#_adding_new_tests">Adding new tests</a></li>
<li><a href="#_adding_new_fingerprints">Adding new fingerprints</a></li>
<li><a href="#_api_runbook">API runbook</a></li>
<li><a href="#howto:db_query">Running database queries</a></li>
<li><a href="#howto:tor-targets">Updating tor targets</a></li>
<li><a href="#howto:api_accounts">Creating API accounts</a></li>
<li><a href="#_fastpath_runbook">Fastpath runbook</a></li>
<li><a href="#apr_runb">Android probe release runbook</a></li>
<li><a href="#clip_runb">CLI probe release runbook</a></li>
<li><a href="#_debian_packages">Debian packages</a></li>
<li><a href="#_deploy_new_host">Deploy new host</a></li>
</ul>
</li>
<li><a href="#_backend_components">Backend components</a></li>
<li><a href="#uploader">API Measurement uploader</a>
<ul class="sectlevel2">
<li><a href="#topic:postcans">Postcan files</a></li>
</ul>
</li>
<li><a href="#s3_msmt">S3 measurement files layout</a>
<ul class="sectlevel2">
<li><a href="#topic:jsonl">JSONL files</a></li>
</ul>
</li>
<li><a href="#_components_todo">Components: TODO</a>
<ul class="sectlevel2">
<li><a href="#comp:nginx">Nginx</a></li>
<li><a href="#comp:haproxy">Haproxy</a></li>
<li><a href="#comp:dehydrated">Dehydrated</a></li>
<li><a href="#tool:jupyter">Jupyter Notebook</a></li>
<li><a href="#tool:grafana">Grafana</a></li>
<li><a href="#comp:click_log">ClickHouse intance for logs</a></li>
<li><a href="#tool:vector">Vector</a></li>
<li><a href="#comp:clickhouse">ClickHouse</a></li>
<li><a href="#topic:schema_changes">Continuous Deployment: Database schema changes</a></li>
</ul>
</li>
<li><a href="#gh_actions">GitHub CI workflows</a>
<ul class="sectlevel2">
<li><a href="#deb_build">Debian package build and publish</a></li>
<li><a href="#docgen">Code documentation generation</a></li>
<li><a href="#_mypy">Mypy</a></li>
<li><a href="#_fastpath_test">Fastpath test</a></li>
<li><a href="#e2e-test">API end-to-end test</a></li>
</ul>
</li>
<li><a href="#_miscellaneous_scripts_running_on_fsn_or_ams_pg_test">Miscellaneous scripts running on FSN or ams-pg-test</a></li>
<li><a href="#_incident_response">Incident response</a>
<ul class="sectlevel2">
<li><a href="#_preparation">Preparation</a></li>
<li><a href="#ntfy">Redundant notifications</a></li>
<li><a href="#_investigating_test_helper_rotation">Investigating test helper rotation</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_backend_documentation">Backend documentation</h2>
<div class="sectionbody">
<div id="purpose" class="sidebarblock">
<div class="content">
<div class="title">Purpose</div>
<div class="paragraph">
<p>This document describes the architecture of the main components of the OONI infrastructure.</p>
</div>
<div class="paragraph">
<p>How to develop, test, deploy and monitor them.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The documentation is meant for core contributors.</p>
</div>
<div class="paragraph">
<p>If you are reading this document as a MarkDown file on github the following button on the top-right menu provides a table of content:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/gh_button.png" alt="toc_button">
</div>
</div>
<div class="sect2">
<h3 id="_progress_report_to_be_deleted_when_finished">Progress report (to be deleted when finished)</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; Create basic general structure</p>
</li>
<li>
<p>&#10003; Prepare a diagram of the main data flow</p>
</li>
<li>
<p>&#10003; log management and Vector</p>
</li>
<li>
<p>&#10003; summarize systemd timers</p>
</li>
<li>
<p>&#10003; deployer tool</p>
</li>
<li>
<p>&#10003; Github CI workflows</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; <a href="#debops-ci">debops-ci tool</a></p>
</li>
<li>
<p>&#10003; Debian repo basic structure</p>
</li>
<li>
<p>&#10003; package build</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; versioning</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10003; Code <a href="#docgen">Code documentation generation</a>  this is a link test <a href="#docgen">fixme</a></p>
</li>
<li>
<p>&#10003; Mypy</p>
</li>
<li>
<p>&#10003; Fastpath</p>
</li>
<li>
<p>&#10003; API</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; describe components not written by ooni</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; <a href="#tool:grafana">Grafana</a> overview</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10003; Describe the most useful dashboards in <a href="https://grafana.ooni.org/" class="bare">https://grafana.ooni.org/</a>
what charts are useful for troubleshooting</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10003; <a href="#comp:haproxy">Haproxy</a></p>
</li>
<li>
<p>&#10003; <a href="#comp:nginx">Nginx</a></p>
</li>
<li>
<p>&#10003; <a href="#comp:dehydrated">Dehydrated</a></p>
</li>
<li>
<p>&#10003; <a href="#tool:ansible">Ansible</a></p>
</li>
<li>
<p>&#10003; <a href="#tool:prometheus">Prometheus</a></p>
</li>
<li>
<p>&#10003; <a href="#tool:grafana">Grafana</a></p>
</li>
<li>
<p>&#10003; <a href="#tool:etckeeper">Etckeeper</a></p>
</li>
<li>
<p>&#10003; <a href="#comp:click_log">ClickHouse intance for logs</a></p>
</li>
<li>
<p>&#10063; <a href="#comp:citizenlab_test_lists_updater">Citizenlab test list updater</a></p>
</li>
<li>
<p>&#10063; <a href="#comp:clickhouse">ClickHouse</a></p>
</li>
<li>
<p>&#10003; <a href="#tool:jupyter">Jupyter Notebook</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; Describe the contents of the <a href="https://github.com/ooni/backend/" class="bare">https://github.com/ooni/backend/</a> in the master branch. Focus on:</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; <a href="#comp:fastpath">Fastpath</a></p>
</li>
<li>
<p>&#10063; <a href="#comp:api">API</a></p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; <a href="#comp:api">API</a></p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; <a href="https://github.com/ooni/backend/issues/761" class="bare">https://github.com/ooni/backend/issues/761</a></p>
</li>
<li>
<p>&#10063; Where the tor targets (bridges and directory authorities) are stored to be given to probes</p>
</li>
<li>
<p>&#10063; How you can update the tor targets to include or exclude certain entries</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; <a href="#pkg:analysis">analysis package</a> package containing various timer that update fingerprints, Citizenlab etc</p>
</li>
<li>
<p>&#10063; test helper rotation</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; Describe the software deployment process and provide examples</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; CI build process</p>
</li>
<li>
<p>&#10063; deployment steps and how to do rollbacks</p>
</li>
<li>
<p>&#10063; monitoring during deployment</p>
</li>
<li>
<p>&#10063; basics on how to do OS updates</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; Provide examples of troubleshooting backend issues using logs</p>
</li>
<li>
<p>&#10063; Provide examples of adding features or making changes</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; To the API</p>
</li>
<li>
<p>&#10063; To the fastpath</p>
</li>
<li>
<p>&#10063; To other scripts</p>
</li>
<li>
<p>&#10063; To grafana</p>
</li>
<li>
<p>&#10063; Adding grafana alerts</p>
</li>
<li>
<p>&#10063; To jupyter notebooks</p>
</li>
</ul>
</div>
</li>
<li>
<p>&#10063; Summarize the notebooks on <a href="https://jupyter.ooni.org/" class="bare">https://jupyter.ooni.org/</a> that I use more often</p>
</li>
<li>
<p>&#10063; Document debugging/metrics scripts manually executed on backend-fsn</p>
</li>
<li>
<p>&#10063; Document high priority tasks and github issues</p>
</li>
<li>
<p>&#10063; Misc</p>
<div class="ulist checklist">
<ul class="checklist">
<li>
<p>&#10063; passwords/keys private repo</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_glossary">Glossary</h3>
<div class="paragraph">
<p>A few shorthands used in the document:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Backend: the whole software stack including the Fastpath, API, tools that transfer data around</p>
</li>
<li>
<p>FSN: The backend-fsn.ooni.org host, running most of the <strong>production</strong> backend infrastructure.</p>
</li>
<li>
<p>ams-pg-test: The ams-pg-test.ooni.org host, running a <strong>test</strong> backend infrastructure.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_architecture">Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The backend infrastructure provides multiple functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Provide APIs for data consumers</p>
</li>
<li>
<p>Instruct probes on what measurements to perform</p>
</li>
<li>
<p>Receive measurements from probes, process them and store them in the database</p>
</li>
<li>
<p>Upload new measurements to a bucket on Amazon S3</p>
</li>
<li>
<p>Fetch data from external sources e.g. fingerprints from a GitHub repository</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_main_data_flows">Main data flows</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This diagram represent the main flow of measurement data.</p>
</div>
<div class="paragraph">
<p>The rectangles represent processes.
The ellipses represent data at rest: as files on disk, files on S3 or records in database tables.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/blockdiag/svg/eNp9UMsKwjAQvPsVSzx78qYoKCp4EASP4iFtN1obm5hNRRD_3fTpo4257c7MzmQCqcIkivkRHj3YGhUgwT5UUhmYAOsLge6xw7gHy7t2WzSfcA4KUcBsN4QzqVQy2NOJa3QElDLWhDWsFdmQpx7CYl7qwQbSTxGcrOb29IcVxZTANcMMOwnNNwdTYLPtelTOQGhucYjECmBV-ZRTy7jRbpBTZvCCqa2UdU8sz-K9_xmyOZY5JY-ctFi9C-12a-63ZHXRHsZX0-3q_W6doX9YzxfAEbc-" alt="Diagram">
</div>
</div>
<div class="paragraph">
<p>Probes submit measurements to the API with a POST at the following path: <a href="https://api.ooni.io/apidocs/#/default/post_report__report_id_" class="bare">https://api.ooni.io/apidocs/#/default/post_report__report_id_</a>
The measurement is optionally decompressed if zstd compression is detected. It is then parsed and added with a unique ID and saved to disk.
Very little validation is done at this time in order to ensure that all incoming measurements are accepted.</p>
</div>
<div class="paragraph">
<p>Measurements are enqueued on disk using one file per measurement. On hourly intervals they are batched together, compressed and uploaded to S3 by the Measurement Uploader.
The batching is performed to allow efficient compression. See the <a href="#uploader">dedicated subchapter</a> for details.</p>
</div>
<div class="paragraph">
<p>The measurement is also sent to the Fastpath. The Fastpath runs as a dedicated daemon with a pool of workers.
It calculates scoring for the measurement and writes a record in the fastpath table.
Each measurement is processed individually in real time.
See the <a href="#comp:fastpath">dedicated subchapter</a> below.</p>
</div>
<div class="paragraph">
<p>The disk queue is also used by the API to access recent measurements that have not been uploaded to S3 yet.
See the <a href="#get_measurement">measurement API</a> for details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conventions">Conventions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Usually backend components have names that are kept consistent across:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Journald unit name</p>
</li>
<li>
<p>Systemd service name</p>
</li>
<li>
<p>Systemd timer name</p>
</li>
<li>
<p>StatsD metrix prefix</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_application_metrics">Application metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All components of the backend are designed to output application metrics.</p>
</div>
<div class="paragraph">
<p>Metrics are prefixed with the name of each application. The metrics are used in <a href="#tool:grafana">Grafana</a> for charts, monitoring and alarming.</p>
</div>
<div class="paragraph">
<p>They use the StatsD protocol over UDP using localhost as destination.
This guarantees that applications never block on metric generation in case the receiver slows down.
The StatsD messages are received by Netdata.
It automatically tracks any new metric, generates averages and summaries as needed and exposes it to <a href="#tool:prometheus">Prometheus</a> for scraping.</p>
</div>
<div class="paragraph">
<p>Application metrics data flow:</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/blockdiag/svg/eNpLyslPzk7JTExXqOZScCwoyMlMTizJzM9TiE7Oz8kvUrBVUFJOS0sFAqVYay4Fv9SSlMSSRGRZkFxaGlg2oCg_N7UkI7W0GIcC96LEtMQ8XNqRrde1Q9iVk5iUmgNSXFySWFKcguIQoDpkW-FKPUJCAoLRHQVUDHWBNVctAAhkUNo=" alt="Diagram">
</div>
</div>
<div class="paragraph">
<p>In Python the statsd library is used e.g.:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>metrics = statsd.StatsClient("localhost", 8125, prefix="ooni-api")</pre>
</div>
</div>
<div class="paragraph">
<p><a href="#tool:prometheus">Prometheus</a> and <a href="#tool:grafana">Grafana</a> provide historical charts for more than 90 days and are useful to investigate long-term trends.</p>
</div>
<div class="paragraph">
<p>Netdata also provides a web UI that can be accessed directly on port 19999.
It can be useful during development, performance optimization and debugging as it provides metrics with higher time granularity (1 second) and almost no delay.</p>
</div>
<div class="paragraph">
<p>Netdata is not exposed on the Internet for security reasons and can be accessed only when nededed by setting up port forwarding using SSH. For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ssh ams-pg-test.ooni.org -L 19998:127.0.0.1:19999</pre>
</div>
</div>
<div class="paragraph">
<p>Netdata can also be run on a development desktop and be accessed locally in order to explore application metrics without having to deploy <a href="#tool:prometheus">Prometheus</a> and <a href="#tool:grafana">Grafana</a>.</p>
</div>
<div class="sect2">
<h3 id="tool:prometheus">Prometheus</h3>
<div class="paragraph">
<p>Prometheus <a href="https://prometheus.io/" class="bare">https://prometheus.io/</a> is a popular monitoring system and runs on <a href="#host:monitoring">monitoring.ooni.org</a></p>
</div>
<div class="paragraph">
<p>It is deployed and configured by <a href="#tool:ansible">Ansible</a> using the following playbook: <a href="https://github.com/ooni/sysadmin/blob/master/ansible/deploy-monitoring.yml" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/deploy-monitoring.yml</a></p>
</div>
<div class="paragraph">
<p>Most of the metrics are collected by scraping Prometheus endpoints, Netdata, and using node exporter.</p>
</div>
</div>
<div class="sect2">
<h3 id="topic:dashboards">Grafana dashboards</h3>
<div class="paragraph">
<p>There is a number of dashboards on <a href="#tool:grafana">Grafana</a> at <a href="https://grafana.ooni.org/" class="bare">https://grafana.ooni.org/</a></p>
</div>
<div class="paragraph">
<p><a href="#tool:grafana">Grafana</a> is deployed on the monitoring.ooni.org host.
It is deployed and configured by <a href="#tool:ansible">Ansible</a> using the following playbook: <a href="https://github.com/ooni/sysadmin/blob/master/ansible/deploy-monitoring.yml" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/deploy-monitoring.yml</a>
This also includes the credentials to access the Web UI</p>
</div>
<div class="paragraph">
<p>The dashboards are used for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Routinely reviewing the general health of the backend infrastructure</p>
</li>
<li>
<p>Predicting long-term scaling requirements, i.e.</p>
</li>
<li>
<p>increasing disk space for the database</p>
</li>
<li>
<p>increasing CPU and memory requirements</p>
</li>
<li>
<p>Investigating alerts and troubleshooting incidents</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="topic:alerting">Alerting</h4>
<div class="paragraph">
<p>Alerts from <a href="#tool:grafana">Grafana</a> and <a href="#tool:prometheus">Prometheus</a> are sent to the #ooni-bots Slack channel <a href="https://app.slack.com/client/T37Q8EGUU/C38EJ0CET" class="bare">https://app.slack.com/client/T37Q8EGUU/C38EJ0CET</a> by a bot.
Slack can be configured to provide desktop notification from browsers and audible notifications on smartphones.</p>
</div>
<div class="paragraph">
<p>Alert flow:</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/blockdiag/svg/eNpLyslPzk7JTExXqOZSCCjKz00tyUgtLVaITs7PyS9SsFVQUk4FgrQ0pVhrLgX3osS0xLxEHLJKyvn5eZm6SfklxUrIStLSQIrASpBs0LWDGwdkKgXnJCZnKzgGeCqBuchGIaQTCwqU0C0CyToV5ZcXpxYB5WoBQ5pAZg==" alt="Diagram">
</div>
</div>
<div class="paragraph">
<p>The alert rules are listed at <a href="https://grafana.ooni.org/alerting/list" class="bare">https://grafana.ooni.org/alerting/list</a>
The list also shows which alerts are firing at the moment, if any.
There is also a handful of alerts configured in <a href="#tool:prometheus">Prometheus</a> using <a href="#tool:ansible">Ansible</a>.</p>
</div>
<div class="paragraph">
<p>The silences list shows if any alert has been temporarily silenced: <a href="https://grafana.ooni.org/alerting/silences" class="bare">https://grafana.ooni.org/alerting/silences</a></p>
</div>
<div class="paragraph">
<p>There are also many dashboards and alerts configured in <a href="#tool:jupyter">Jupyter Notebook</a>.
These are meant for metrics that require more complex algorithms, predictions and SQL queries that cannot be implemented using <a href="#tool:grafana">Grafana</a>.</p>
</div>
<div class="paragraph">
<p>On many dashboards you can set the averaging timespan and the target hostname using fields on the top left.</p>
</div>
<div class="paragraph">
<p>Here is an overview of the most useful dashboards:</p>
</div>
</div>
<div class="sect3">
<h4 id="dash:api_fp">API and fastpath</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/l-MQSGonk/api-and-fastpath-multihost?orgId=1&amp;var-avgspan=1h&amp;var-host=backend-fsn.ooni.org" class="bare">https://grafana.ooni.org/d/l-MQSGonk/api-and-fastpath-multihost?orgId=1&amp;var-avgspan=1h&amp;var-host=backend-fsn.ooni.org</a></p>
</div>
<div class="paragraph">
<p>This is the most important dashboard showing the metrics of the <a href="#comp:api">API</a> and the <a href="#comp:fastpath">Fastpath</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_test_list_repository_in_the_api">Test-list repository in the API</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/siWZslSVk/api-test-list-repo?orgId=1" class="bare">https://grafana.ooni.org/d/siWZslSVk/api-test-list-repo?orgId=1</a></p>
</div>
<div class="paragraph">
<p>Shows timings around the git repository checked out by the <a href="#comp:api">API</a> that contains the test lists.</p>
</div>
</div>
<div class="sect3">
<h4 id="dash:uploader">API uploader dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/ma3Q6GzVz/api-uploader?orgId=1" class="bare">https://grafana.ooni.org/d/ma3Q6GzVz/api-uploader?orgId=1</a></p>
</div>
<div class="paragraph">
<p>Metrics, timing and data transferred by the <a href="#uploader">measurement uploader script</a></p>
</div>
</div>
<div class="sect3">
<h4 id="dash:fp_up">Fingerprint updater dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/JNlK8ox4z/fingerprints?orgId=1&amp;from=now-12h&amp;to=now&amp;refresh=5m" class="bare">https://grafana.ooni.org/d/JNlK8ox4z/fingerprints?orgId=1&amp;from=now-12h&amp;to=now&amp;refresh=5m</a></p>
</div>
<div class="paragraph">
<p>Metrics and timing from the</p>
</div>
</div>
<div class="sect3">
<h4 id="dash:clickhouse">ClickHouse dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/thEkJB_Mz/clickhouse?orgId=1" class="bare">https://grafana.ooni.org/d/thEkJB_Mz/clickhouse?orgId=1</a></p>
</div>
<div class="paragraph">
<p>ClickHouse-specific performance metrics</p>
</div>
</div>
<div class="sect3">
<h4 id="dash:haproxy">Haproxy dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/ba33e4df-d686-4459-b37d-3966af14ad00/haproxy?orgId=1" class="bare">https://grafana.ooni.org/d/ba33e4df-d686-4459-b37d-3966af14ad00/haproxy?orgId=1</a></p>
</div>
<div class="paragraph">
<p>Basic metrics from <a href="#comp:haproxy">Haproxy</a> load balancers</p>
</div>
</div>
<div class="sect3">
<h4 id="dash:cert">TLS certificate dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/-1mr7sWMk/ssl-certificates?orgId=1&amp;from=now-7d&amp;to=now&amp;refresh=5s" class="bare">https://grafana.ooni.org/d/-1mr7sWMk/ssl-certificates?orgId=1&amp;from=now-7d&amp;to=now&amp;refresh=5s</a></p>
</div>
<div class="paragraph">
<p>Certificate expiration times.
There are alerts configured in <a href="#tool:grafana">Grafana</a> to alert on expiring certificates.</p>
</div>
</div>
<div class="sect3">
<h4 id="dash:db_backup">Database backup dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/aQjQYhoGz/db-backup?orgId=1" class="bare">https://grafana.ooni.org/d/aQjQYhoGz/db-backup?orgId=1</a></p>
</div>
<div class="paragraph">
<p>Metrics, timing and data transferred by <a href="#comp:db_backup">Database backup tool</a></p>
</div>
</div>
<div class="sect3">
<h4 id="dash:detector">Event detector dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/FH2TmwFVz/event-detection?orgId=1&amp;refresh=1m" class="bare">https://grafana.ooni.org/d/FH2TmwFVz/event-detection?orgId=1&amp;refresh=1m</a></p>
</div>
<div class="paragraph">
<p>Basic metrics from the <a href="#detector">social media blocking event detector</a></p>
</div>
</div>
<div class="sect3">
<h4 id="dash:geoip">GeoIP MMDB database dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/0e6eROj7z/geoip?orgId=1&amp;from=now-7d&amp;to=now" class="bare">https://grafana.ooni.org/d/0e6eROj7z/geoip?orgId=1&amp;from=now-7d&amp;to=now</a></p>
</div>
<div class="paragraph">
<p>Age and size of the GeoIP MMDB database.
Also, a chart showing discrepancies between the GeoIP lookup performed by the probes VS the one in the API, used to gauge the benefits of using a centralized solution.</p>
</div>
</div>
<div class="sect3">
<h4 id="_host_clock_offset_dashboard">Host clock offset dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/9dLa-RSnk/host-clock-offset?orgId=1" class="bare">https://grafana.ooni.org/d/9dLa-RSnk/host-clock-offset?orgId=1</a></p>
</div>
<div class="paragraph">
<p>Measures NTP clock sync and alarms on big offsets</p>
</div>
</div>
<div class="sect3">
<h4 id="_netdata_specific_dashboard">Netdata-specific dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/M1rOa7CWz/netdata?orgId=1&amp;var-instance=backend-fsn.ooni.org:19999" class="bare">https://grafana.ooni.org/d/M1rOa7CWz/netdata?orgId=1&amp;var-instance=backend-fsn.ooni.org:19999</a></p>
</div>
<div class="paragraph">
<p>Shows all the metrics captured by Netdata - useful for in-depth performance investigation.</p>
</div>
</div>
<div class="sect3">
<h4 id="dash:asnmeta_updater">ASN metadata updater dashboard</h4>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/XRihZL-Vk/ansmeta-update?orgId=1&amp;from=now-7d" class="bare">https://grafana.ooni.org/d/XRihZL-Vk/ansmeta-update?orgId=1&amp;from=now-7d</a></p>
</div>
<div class="paragraph">
<p>Progress, runtime and table size of the <a href="#comp:asnmeta_updater">ASN metadata updater</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="logman">Log management</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All components of the backend are designed to output logs to Systemd&#8217;s journald. They usually log using the component name as unit name.
Sometimes you might have to use <code>--identifier &lt;name&gt;</code> instead.</p>
</div>
<div class="paragraph">
<p>Journald automatically indexes logs by time, unit name and other items. This allows to quickly filter logs during troubleshooting, for example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo journalctl -u ooni-api --since '10 m ago'</pre>
</div>
</div>
<div class="paragraph">
<p>Or follow live logs using e.g.:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo journalctl -u nginx -f</pre>
</div>
</div>
<div class="paragraph">
<p>Sometimes it is useful to show milliseconds in the timestamps:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo journalctl -f -u ooni-api -o short-precise</pre>
</div>
</div>
<div class="paragraph">
<p>The logger used in Python components also sets additional fields, notably CODE_FUNC and CODE_LINE</p>
</div>
<div class="paragraph">
<p>Available fields can be listed using:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo journalctl -f -u ooni-api  -N | sort</pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to filter by those fields. It comes very handy for debugging e.g.:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo journalctl -f -u ooni-api CODE_FUNC=open_report</pre>
</div>
</div>
<div class="paragraph">
<p>Every host running backend services also sends host to monitoring.ooni.org using <a href="#tool:vector">Vector</a>.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/blockdiag/svg/eNqFj8EKgzAQRO9-xZKe9ZqDtFAK0i_oRXrQuAnBNCtReyn-e9cKNRahc1qWtzsztSPVNrYy8Erg3HXOqmqw5CE9wQ3VQCHt0TcYokVAhfa5rC580F5p7DHf3peKHAU4gjhojSxxZ2L7MmJmQuuY-brsU6vxPpCACTR2cy1WlCzfhuBX0w_8rybLVTW62fFB3jJsvcmIx4yCEQuyhpKyKKQUH6fpDWcwdjA=" alt="Diagram">
</div>
</div>
<div class="paragraph">
<p>There is a dedicated ClickHouse instance on monitoring.ooni.org used to collect logs.
See the <a href="#comp:click_log">ClickHouse intance for logs</a>.
This is done to avoid adding unnecessary load to the production database on FSN that contains measurements and also keep a copy of FSN&#8217;s logs on a different host.</p>
</div>
<div class="paragraph">
<p>The receiving <a href="#tool:vector">Vector</a> instance and ClickHouse are deployed and configured by <a href="#tool:ansible">Ansible</a> using the following playbook: <a href="https://github.com/ooni/sysadmin/blob/master/ansible/deploy-monitoring.yml" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/deploy-monitoring.yml</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sys_timers">Systemd timers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some backend components like the API and Fastpath run as daemons. Many other run as Systemd timers at various intervals.</p>
</div>
<div class="paragraph">
<p>The latter approach ensures that a component will start again at the next time interval even if the previous run crashed out.
This provides a moderate reliability benefit at the expense of having to perform initialization and shutdown at every run.</p>
</div>
<div class="paragraph">
<p>To show the existing timers and their next start time run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>systemctl list-timers</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary_of_timers">Summary of timers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Here is a summary of the most important timers used in the backend:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>UNIT                           ACTIVATES
dehydrated.timer               dehydrated.service
detector.timer                 detector.service
ooni-api-uploader.timer        ooni-api-uploader.service
ooni-db-backup.timer           ooni-db-backup.service
ooni-download-geoip.timer      ooni-download-geoip.service
ooni-rotation.timer            ooni-rotation.service
ooni-update-asn-metadata.timer ooni-update-asn-metadata.service
ooni-update-citizenlab.timer   ooni-update-citizenlab.service
ooni-update-fingerprints.timer ooni-update-fingerprints.service</pre>
</div>
</div>
<div class="paragraph">
<p>Ooni-developed timers have a matching unit file with .service extension.</p>
</div>
<div class="paragraph">
<p>To show the existing timers and their next start time run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>systemctl list-timers</pre>
</div>
</div>
<div class="paragraph">
<p>This can be useful for debugging.</p>
</div>
<div class="sect2">
<h3 id="_dehydrated_timer">Dehydrated timer</h3>
<div class="paragraph">
<p>Runs the Dehydrated ACME tool, see <a href="#comp:dehydrated">Dehydrated</a></p>
</div>
<div class="paragraph">
<p>is a simple script that provides ACME support for Letsencrypt. It&#8217;s integrated with Nginx or Haproxy with custom configuration or a small script as "glue".</p>
</div>
</div>
<div class="sect2">
<h3 id="timer:detector">Detector timer</h3>
<div class="paragraph">
<p>Runs the <a href="#detector">social media blocking event detector</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="timer:uploader">ooni-api-uploader timer</h3>
<div class="paragraph">
<p>Runs the <a href="#uploader">Measurement uploader</a>.
It is installed by the <a href="#pkg:analysis">analysis package</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="timer:db_backup">ooni-db-backup timer</h3>
<div class="paragraph">
<p>Runs the <a href="#comp:db_backup">Database backup tool</a>
Also installed by the <a href="#pkg:analysis">analysis package</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="timer:geoip">ooni-download-geoip timer</h3>
<div class="paragraph">
<p>Fetches GeoIP databases, installed by the <a href="#comp:api">ooni-api</a>.</p>
</div>
<div class="paragraph">
<p>Monitored with the <a href="#dash:geoip">GeoIP dashboard</a></p>
</div>
</div>
<div class="sect2">
<h3 id="timer:rotation">ooni-rotation timer</h3>
<div class="paragraph">
<p>Runs the test helper rotation script, installed by the <a href="#pkg:analysis">analysis package</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ooni_update_asn_metadata_timer_timer">ooni-update-asn-metadata timer [[timer:</h3>
<div class="paragraph">
<p>Fetches ASN metadata, installed by the <a href="#pkg:analysis">analysis package</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="timer:citizenlab">ooni-update-citizenlab</h3>
<div class="paragraph">
<p>Fetches Citizenlab data from GitHub, installed by the <a href="#pkg:analysis">analysis package</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ooni_update_fingerprints">ooni-update-fingerprints</h3>
<div class="paragraph">
<p>Fetches fingerprints from GitHub, installed by the <a href="#pkg:analysis">analysis package</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="comp:api">API</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The API entry points are documented at <a href="https://api.ooni.io/apidocs/">apidocs</a></p>
</div>
<div class="sect2">
<h3 id="_measurements">Measurements</h3>
<div class="paragraph">
<p>Provide access to measurements to end users directly and through Explorer.</p>
</div>
<div class="paragraph">
<p>Mounted under /api/v1/measurement/</p>
</div>
<div class="paragraph">
<p>The API is versioned. Access is rate limited based on source IP address and access tokens
due to the computational cost of running heavy queries on the database.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/ooni/api/blob/master/newapi/ooniapi/probe_services.py">Sources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="comp:mat">MAT</h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="_probe_services">Probe services</h3>
<div class="paragraph">
<p>Serves lists of collectors and test helpers to the probes and receive measurements from them.</p>
</div>
<div class="paragraph">
<p>Mounted under /api/v1/</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/ooni/api/blob/master/newapi/ooniapi/probe_services.py">Sources</a></p>
</div>
<div class="sect3">
<h4 id="comp:incidents">Incident management</h4>

</div>
<div class="sect3">
<h4 id="comp:prio">Prioritization</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_private_entry_points">Private entry points</h3>
<div class="paragraph">
<p>Not for public consumption. Mounted under <code>/api/_</code> and used exclusively by Explorer</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/ooni/api/blob/master/newapi/ooniapi/private.py">Sources</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_codebase">Codebase</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>api/ooni_api_uploader.py</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>api/ooniapi/aggregation.py
api/ooniapi/app.py
api/ooniapi/auth.py
api/ooniapi/citizenlab.py
api/ooniapi/config.py
api/ooniapi/data.py
api/ooniapi/database.py
api/ooniapi/errors.py
api/ooniapi/incidents.py
api/ooniapi/measurements.py
api/ooniapi/models.py
api/ooniapi/oonirun.py
api/ooniapi/pages/docs.py
api/ooniapi/prio.py
api/ooniapi/private.py
api/ooniapi/probe_services.py
api/ooniapi/rate_limit_quotas.py
api/ooniapi/urlparams.py
api/ooniapi/utils.py
api/ooniapi/views.py
api/ooniapi/wsgi.py
api/rate_limit_quotas.py
api/tests/conftest.py
api/tests/functional/test_private_explorer.py
api/tests/functional/test_probe_services.py
api/tests/integ/test_aggregation.py
api/tests/integ/test_citizenlab.py
api/tests/integ/test_incidents.py
api/tests/integ/test_integration.py
api/tests/integ/test_integration_auth.py
api/tests/integ/test_oonirun.py
api/tests/integ/test_params_validation.py
api/tests/integ/test_prioritization.py
api/tests/integ/test_prioritization_nodb.py
api/tests/integ/test_private_api.py
api/tests/integ/test_probe_services.py
api/tests/integ/test_probe_services_nodb.py
api/tests/integ/test_rate_limiter.py
api/tests/integ/test_torsf_stats.py
api/tests/unit/test_auth.py
api/tests/unit/test_countries.py
api/tests/unit/test_oonirun.py
api/tests/unit/test_prio.py
api/tests/unit/test_unit.py
api/tests/utils.py</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>api/tools/monitor_test_list.py</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tor_targets">Tor targets</h3>
<div class="paragraph">
<p>Tor targets are served at path <code>/api/v1/test-list/tor-targets</code>
They are read from a configuration file.
The path is set in the main configuration file and it usually is <code>/etc/ooni/tor_targets.json</code>.</p>
</div>
<div class="paragraph">
<p>To make changes in the Tor targets see the runbook <a href="#howto:tor-targets">Updating tor targets</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="comp:fastpath">Fastpath</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO extract existing documentation from codebase
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="comp:test-helpers">Test helpers</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_fastpath_codebase">Fastpath codebase</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>fastpath/database_upgrade_schema.py
fastpath/fastpath/core.py
fastpath/fastpath/db.py
fastpath/fastpath/__init__.py
fastpath/fastpath/metrics.py
fastpath/fastpath/normalize.py
fastpath/fastpath/reprocessor.py
fastpath/fastpath/s3feeder.py
fastpath/fastpath/tests/test_functional_nodb.py
fastpath/fastpath/tests/test_functional_normalize.py
fastpath/fastpath/tests/test_functional.py
fastpath/fastpath/tests/test_unit.py
fastpath/fastpath/utils.py</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comp:analysis">Analysis</h3>
<div class="paragraph">
<p>Miscellaneous scripts, services and tools. It contains ancilliary components that are not updated often and might not justify a dedicated Debian package for each of them.</p>
</div>
<div class="paragraph">
<p>Deployed using the <a href="#pkg:analysis">analysis package</a></p>
</div>
<div class="paragraph">
<p><a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/" class="bare">https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/</a></p>
</div>
<div class="paragraph">
<p>TODO add alerts</p>
</div>
<div class="paragraph">
<p>See the subchapters for details:</p>
</div>
<div class="sect3">
<h4 id="comp:citizenlab_test_lists_updater">Citizenlab test list updater</h4>
<div class="paragraph">
<p>This component fetches the test lists from <a href="https://github.com/citizenlab/test-lists" class="bare">https://github.com/citizenlab/test-lists</a> and populates
the <a href="#tbl:citizenlab">citizenlab table</a> and <a href="#tbl:citizenlab_flip">citizenlab_flip table</a>.</p>
</div>
<div class="paragraph">
<p>The git repository <a href="https://github.com/citizenlab/test-lists.git" class="bare">https://github.com/citizenlab/test-lists.git</a> is cloned as an unauthenticated user.</p>
</div>
<div class="paragraph">
<p>Database writes are performed as the <code>citizenlab</code> user.</p>
</div>
<div class="paragraph">
<p>The tables have few constraints on the database side: most of the validation is done in the script and it is meant to be strict.
The updater overwrites <a href="#tbl:citizenlab_flip">citizenlab_flip table</a> and then swaps it with <a href="#tbl:citizenlab">citizenlab table</a> atomically.
In case of failure during git cloning, verification and table overwrite the final swap does not happen, leaving the <code>citizenlab</code> table unaltered.</p>
</div>
<div class="paragraph">
<p>It is deployed using the <a href="#pkg:analysis">analysis package</a> and started by the <a href="#timer:citizenlab">ooni-update-citizenlab</a> Systemd timer.</p>
</div>
<div class="paragraph">
<p>Logs are generated as the <code>analysis.citizenlab_test_lists_updater</code> unit.</p>
</div>
<div class="paragraph">
<p>Also it generates the following metrics with the <code>citizenlab_test_lists_updater</code> prefix:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fetch_citizen_lab_lists</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fetch duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>update_citizenlab_table</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>citizenlab_test_list_len</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gauge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Table size</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The updater lives in one file: <a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/citizenlab_test_lists_updater.py" class="bare">https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/citizenlab_test_lists_updater.py</a></p>
</div>
<div class="paragraph">
<p>To run the updater manually during development:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>PYTHONPATH=analysis ./run_analysis --update-citizenlab --dry-run --stdout</pre>
</div>
</div>
<div class="paragraph">
<p>TODO grafana charts and alerts</p>
</div>
</div>
<div class="sect3">
<h4 id="comp:fingerprint_updater">Fingerprint updater</h4>
<div class="paragraph">
<p>This component fetches measurement fingerprints as CSV files from <a href="https://github.com/ooni/blocking-fingerprints" class="bare">https://github.com/ooni/blocking-fingerprints</a>
and populates
 <a href="#tbl:fingerprints_dns">fingerprints_dns table</a>, <a href="#tbl:fingerprints_dns_tmp">fingerprints_dns_tmp table</a>, <a href="#tbl:fingerprints_http">fingerprints_http table</a> and <a href="#tbl:fingerprints_http_tmp">fingerprints_http_tmp table</a>.</p>
</div>
<div class="paragraph">
<p>The tables without <code>_tmp</code> are used by the <a href="#comp:fastpath">Fastpath</a>.</p>
</div>
<div class="paragraph">
<p>The CSV files are fetched directly without git-cloning.</p>
</div>
<div class="paragraph">
<p>Database writes are performed as the <code>api</code> user, configured in
<a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/analysis.py#L64" class="bare">https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/analysis.py#L64</a></p>
</div>
<div class="paragraph">
<p>The tables have no constraints on the database side and basic validation is performed by the script:
<a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/fingerprints_updater.py#L91" class="bare">https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/fingerprints_updater.py#L91</a></p>
</div>
<div class="paragraph">
<p>The updater overwrites the tables ending with <code>_tmp</code> and then swaps them with the "real" tables atomically.
In case of failure the final swap does not happen, leaving the "real" tables unaltered.</p>
</div>
<div class="paragraph">
<p>It is deployed using the <a href="#pkg:analysis">analysis package</a> and started by the <a href="#timer:citizenlab">ooni-update-citizenlab</a> Systemd timer.</p>
</div>
<div class="paragraph">
<p>Logs are generated as the <code>analysis.fingerprints_updater</code> unit.</p>
</div>
<div class="paragraph">
<p>Also it generates the following metrics with the <code>fingerprints_updater</code> prefix:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fetch_csv</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CSV fetch duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fingerprints_update_progress</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gauge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update progress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fingerprints_dns_tmp_len</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gauge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DNS table size</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fingerprints_http_tmp_len</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gauge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">HTTP table size</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See the <a href="#dash:fp_up">Fingerprint updater dashboard</a> on Grafana.</p>
</div>
<div class="paragraph">
<p>The updater lives primarily in
<a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/fingerprints_updater.py" class="bare">https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/fingerprints_updater.py</a>
and it&#8217;s called by the <code>analysis.py</code> script</p>
</div>
<div class="paragraph">
<p>To run the updater manually during development:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>PYTHONPATH=analysis ./run_analysis --update-citizenlab --dry-run --stdout</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="comp:asnmeta_updater">ASN metadata updater</h4>
<div class="paragraph">
<p>This component fetches ASN metadata from <a href="https://archive.org/download/ip2country-as" class="bare">https://archive.org/download/ip2country-as</a> (generated via: <a href="https://github.com/ooni/historical-geoip" class="bare">https://github.com/ooni/historical-geoip</a>)</p>
</div>
<div class="paragraph">
<p>It populates the <a href="#tbl:asnmeta">asnmeta table</a> and <a href="#tbl:asnmeta_tmp">asnmeta_tmp table</a>.</p>
</div>
<div class="paragraph">
<p><a href="#tbl:asnmeta">asnmeta table</a> is used by the private <a href="#comp:api">API</a>, see:
<a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/api/ooniapi/private.py#L923" class="bare">https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/api/ooniapi/private.py#L923</a>
and <a href="https://api.ooni.io/apidocs/#/default/get_api___asnmeta" class="bare">https://api.ooni.io/apidocs/#/default/get_api___asnmeta</a></p>
</div>
<div class="paragraph">
<p>Database writes are performed as the <code>api</code> user, configured in
<a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/analysis.py#L64" class="bare">https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/analysis.py#L64</a></p>
</div>
<div class="paragraph">
<p>The table has no constraints on the database side and basic validation is performed by the script:
<a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/asnmeta_updater.py#L95" class="bare">https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/analysis/analysis/asnmeta_updater.py#L95</a></p>
</div>
<div class="paragraph">
<p>Logs are generated as the <code>analysis.asnmeta_updater</code> unit.</p>
</div>
<div class="paragraph">
<p>Also it generates the following metrics with the <code>asnmeta_updater</code> prefix:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fetch_data</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data fetch duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>asnmeta_update_progress</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gauge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update progress</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>asnmeta_tmp_len</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gauge</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">table size</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See the <a href="#dash:asnmeta_updater">ASN metadata updater dashboard</a> on Grafana.</p>
</div>
<div class="paragraph">
<p>To run the updater manually during development:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>PYTHONPATH=analysis ./run_analysis --update-asnmeta --stdout</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="comp:db_backup">Database backup tool</h4>
<div class="paragraph">
<p>The backup tool is a service that regularly backs up <a href="#comp:clickhouse">ClickHouse</a> tables to S3.
It also exports tables in <code>CSV.zstd</code> format for public consumption.</p>
</div>
<div class="paragraph">
<p>Contrarily to similar tools, it is designed to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>extract data in chunks and upload it without creating temporary files</p>
</li>
<li>
<p>without requiring transaction support in the database (not available in ClickHouse)</p>
</li>
<li>
<p>without requiring transactional filesystems or interrupting the database workload</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is configured by <a href="#tool:ansible">Ansible</a> using the <code>/etc/ooni/db-backup.conf</code> file.
Runs as a SystemD service, see <a href="#timer:db_backup">ooni-db-backup timer</a></p>
</div>
<div class="paragraph">
<p>It compresses data using <a href="https://facebook.github.io/zstd/" class="bare">https://facebook.github.io/zstd/</a> during the upload.</p>
</div>
<div class="paragraph">
<p>The tool chunks tables as needed and add sleeps as needed to prevent a query backlog impacting the database performance.</p>
</div>
<div class="paragraph">
<p>Logs are generated as the <code>ooni-db-backup</code> unit.</p>
</div>
<div class="paragraph">
<p>Also it generates the following metrics with the <code>db-backup</code> prefix:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric name</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>upload_to_s3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data upload duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>run_export</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Data export duration</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>table_{tblname}_backup_time_ms</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">timer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Table backup time (multiple metrics)</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See the <a href="#dash:db_backup">Database backup dashboard</a> on Grafana.</p>
</div>
<div class="paragraph">
<p>Monitor with:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo journalctl -f --identifier ooni-db-backup</pre>
</div>
</div>
<div class="paragraph">
<p>Future improvements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/ooni/backend/issues/766">private/public backups</a></p>
</li>
<li>
<p><a href="https://github.com/ooni/backend/issues/767">safer table backup workflow</a></p>
</li>
<li>
<p><a href="https://github.com/ooni/backend/issues/765">database schema backup</a>. For extracting the schema see <a href="#topic:schema_check">Database schema check</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_ancilliary_modules">Ancilliary modules</h4>
<div class="paragraph">
<p><code>analysis/analysis/analysis.py</code> is the main analysis script and acts as a wrapper to other components.</p>
</div>
<div class="paragraph">
<p><code>analysis/analysis/metrics.py</code> is a tiny wrapper for the Statsd Python library.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="detector">Social media blocking event detector</h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="comp:ooni-bridges">OONI bridges</h3>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
<div class="sect2">
<h3 id="rotation">Test helper rotation</h3>
<div class="paragraph">
<p>The test helper rotation script is responsible for spawning and deploying VMs on Digital Ocean to be used as <a href="#comp:test-helpers">Test helpers</a>
The primary functions are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Select datacenters and spawn VMs. This allows having helpers to live in many countries, datacenters and subnets making attempts at blocking them more difficult.</p>
</li>
<li>
<p>Runs a setup script on the host at first boot</p>
</li>
<li>
<p>Keeps a list of live and old hosts in a dedicated database table</p>
</li>
<li>
<p>Create SSL certificates using the Digital Ocean API</p>
</li>
<li>
<p>Performs end-to-end test on newly created VMs to ensure the test helper service is running</p>
</li>
<li>
<p>Update DNS to publish new services</p>
</li>
<li>
<p>Drain and destroy old VMs</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is designed to be extended:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Support multiple cloud services. The database tables already contain columns to track VMs on different cloud providers.</p>
</li>
<li>
<p>Support deploying <a href="#comp:ooni-bridges">OONI bridges</a>. This can provide frequently changing "entry point" IP addresses for probes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The script is deployed on <a href="#host:FSN">backend-fsn.ooni.org</a> using the <a href="#pkg:analysis">analysis deb package</a></p>
</div>
<div class="paragraph">
<p>The configuration is deployed using <a href="#tool:ansible">Ansible</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>/etc/ooni/rotation.conf</code>: main configuration file deployed using <a href="https://github.com/ooni/sysadmin/blob/master/ansible/roles/ooni-backend/tasks/main.yml" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/roles/ooni-backend/tasks/main.yml</a></p>
</li>
<li>
<p><code>/etc/ooni/rotation_setup.sh</code>: this script is executed on the VMs for configuration, see <a href="https://github.com/ooni/sysadmin/blob/master/ansible/roles/ooni-backend/templates/rotation_nginx_conf" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/roles/ooni-backend/templates/rotation_nginx_conf</a></p>
</li>
<li>
<p><code>/etc/ooni/rotation_nginx_conf</code>: configuration for Nginx to be deployed on the VMs, see <a href="https://github.com/ooni/sysadmin/blob/master/ansible/roles/ooni-backend/templates/rotation_setup.sh" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/roles/ooni-backend/templates/rotation_setup.sh</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Test helpers are named <code>&lt;number&gt;.th.ooni.org</code>. This is required to generate <code>*.th.ooni.org</code> certificates.</p>
</div>
<div class="sect3">
<h4 id="_internals">Internals</h4>
<div class="paragraph">
<p>The tool reads /etc/ooni/rotation.conf</p>
</div>
<div class="paragraph">
<p>It uses the following APIs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Digital Ocean API: DNS A/AAAA records</p>
</li>
<li>
<p>Digital Ocean API: Live droplets</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other stateful data exists only in:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>test_helper_instances database table</p>
</li>
<li>
<p>"Let&#8217;s Encrypt" SSL certificates for <code>*.th.ooni.org</code> temporarily stored on local host and pushed to the test helpers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the database table setup see <a href="#tbl:test_helper_instances">test_helper_instances table</a>.</p>
</div>
<div class="paragraph">
<p>Example of /etc/ooni/rotation.conf</p>
</div>
<div class="literalblock">
<div class="content">
<pre>[DEFAULT]
token = CHANGEME
active_droplets_count = 4
size_slug = s-1vcpu-1gb
image_name = debian-10-x64
draining_time_minutes = 240
dns_zone = th.ooni.org</pre>
</div>
</div>
<div class="paragraph">
<p>Simple example for /etc/ooni/rotation_setup.sh:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>#!/bin/bash
# Configure test-helper droplet
# This script is run as root and with CWD=/
set -euo pipefail
exec 1&gt;setup.log 2&gt;&amp;1
echo "deb [trusted=yes] https://ooni-internal-deb.s3.eu-central-1.amazonaws.com unstable main" &gt; /etc/apt/sources.list.d/ooni.list
apt-key adv --verbose --keyserver hkp://keyserver.ubuntu.com --recv-keys 'B5A08F01796E7F521861B449372D1FF271F2DD50'
apt-get update
apt-get upgrade -qy
echo &gt; /etc/motd
apt-get install -qy oohelperd
apt-get install -qy oohelperd nginx-light</pre>
</div>
</div>
<div class="paragraph">
<p>It is activated by the <a href="#timer:rotation">ooni-rotation timer</a> Systemd timer
Generates metrix prefixed as <code>rotation</code> and logs as a journald unit named <code>rotation</code>.</p>
</div>
<div class="paragraph">
<p>Related files in the backend repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>analysis/rotation.py
analysis/tests/test_rotation.py</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The script has no access to security-critical credentials for services like Namecheap, however it has the ability to spawn VMs and control Digital Oceans&#8217;s DNS.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_misc_scripts">Misc scripts</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>misc/asn_cc_match_monitor.py
misc/test_list_change_monitor.py
misc/tor_connectivity_monitor.py</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database">Database</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hosts">Hosts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section provides a summary of the backend hosts described in the rest of the document.</p>
</div>
<div class="paragraph">
<p>A full list is available at <a href="https://github.com/ooni/sysadmin/blob/master/ansible/inventory.yml" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/inventory.yml</a> - also see <a href="#tool:ansible">Ansible</a></p>
</div>
<div class="sect2">
<h3 id="host:FSN">backend-fsn.ooni.org</h3>
<div class="paragraph">
<p>Public-facing production backend host, receiving the deployment of the packages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#pkg:ooni-api">ooni-api</a></p>
</li>
<li>
<p><a href="#pkg:fastpath">fastpath</a></p>
</li>
<li>
<p><a href="#pkg:analysis">analysis</a></p>
</li>
<li>
<p><a href="#pkg:detector">detector</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="host:HEL">backend-hel.ooni.org</h3>
<div class="paragraph">
<p>Standby / pre-production backend host. Runs the same software stack as <a href="#host:FSN">backend-fsn.ooni.org</a></p>
</div>
</div>
<div class="sect2">
<h3 id="host:test">ams-pg-test.ooni.org</h3>
<div class="paragraph">
<p>Testbed backend host. Runs the same software stack as <a href="#host:FSN">backend-fsn.ooni.org</a>. Database tables are not backed up and incoming measurements are not uploaded to S3. All data is considered ephemeral.</p>
</div>
</div>
<div class="sect2">
<h3 id="host:monitoring">monitoring.ooni.org</h3>
<div class="paragraph">
<p>Runs the internal monitoring stack, including <a href="#tool:jupyter">Jupyter Notebook</a>, <a href="#tool:prometheus">Prometheus</a>, <a href="#tool:vector">Vector</a> and <a href="#comp:click_log">ClickHouse intance for logs</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_infrastructure">Infrastructure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This part describes tools used to manage the infrastructure.</p>
</div>
<div class="sect2">
<h3 id="_the_sysadmin_repository">The Sysadmin repository</h3>
<div class="paragraph">
<p>This is a git repository living at <a href="https://github.com/ooni/sysadmin/" class="bare">https://github.com/ooni/sysadmin/</a> for internal use. It primarily contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Playbooks for <a href="#tool:ansible">Ansible</a></p>
</li>
<li>
<p>The <a href="#debops-ci">debops-ci tool</a></p>
</li>
<li>
<p>Scripts and tools including diagrams for <a href="#dns">DNS and Domains</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="tool:ansible">Ansible</h3>
<div class="paragraph">
<p>Ansible is used to configure the OSes on the backend hosts and manage the configuration of backend components.
The playbooks are kept at <a href="https://github.com/ooni/sysadmin/tree/master/ansible" class="bare">https://github.com/ooni/sysadmin/tree/master/ansible</a></p>
</div>
<div class="paragraph">
<p>This manual supersedes <a href="https://github.com/ooni/sysadmin/blob/master/README.md" class="bare">https://github.com/ooni/sysadmin/blob/master/README.md</a></p>
</div>
<div class="sect3">
<h4 id="_installation_and_setup">Installation and setup</h4>
<div class="paragraph">
<p>Install Ansible using a Python virtualenv or OS packages. Ensure the same major+minor version is used across the team.</p>
</div>
<div class="paragraph">
<p>Secrets are stored in vaults using the <code>ansible/vault</code> script as a wrapper for <code>ansible-vault</code>.
Store encrypted variables with a <code>vault_</code> prefix to make world [a more grepable place](<a href="http://docs.ansible.com/ansible/playbooks_best_practices.html#best-practices-for-variables-and-vaults" class="bare">http://docs.ansible.com/ansible/playbooks_best_practices.html#best-practices-for-variables-and-vaults</a>)
and link location of the variable using same name without prefix in corresponding <code>vars.yml</code>.
<code>scripts/ansible-syntax-check</code> checks links between vaults and plaintext files during Travis build.
<code>ansible/play</code> wrapper for <code>ansible-playbook</code> will execute a playbook with proper vault secret and inventory.</p>
</div>
<div class="paragraph">
<p>In order to access secrets stored inside of the vault, you will need a copy of
the vault password encrypted with your PGP key. This file should be stored
inside of <code>~/.ssh/ooni-sysadmin.vaultpw.gpg</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ssh_configuration">SSH Configuration</h4>
<div class="paragraph">
<p>You should configure your <code>~/.ssh/config</code> with the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>IdentitiesOnly yes
ServerAliveInterval 120
UserKnownHostsFile ~/.ssh/known_hosts ~/REPLACE_ME/sysadmin/ext/known_hosts

host *.ooni.io
  user YOUR_USERNAME

host *.ooni.nu
  user YOUR_USERNAME

host *.ooni.org
  user YOUR_USERNAME</code></pre>
</div>
</div>
<div class="paragraph">
<p>Replace <code>~/REPLACE_ME/sysadmin/ext/known_hosts</code> to where you have cloned the
<code>ooni/sysadmin</code> repo. This will ensure you use the host key fingeprints from
this repo instead of just relying on TOFU.</p>
</div>
<div class="paragraph">
<p>You should replace <code>YOUR_USERNAME</code> with your username from <code>adm_login</code>.</p>
</div>
<div class="paragraph">
<p>On macOS you may want to also add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>host *
    UseKeychain yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use the Keychain to store passwords.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ansible_playbooks_summary">Ansible playbooks summary</h4>
<div class="paragraph">
<p>Usage:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./play deploy-&lt;component&gt;.yml -l &lt;hostname&gt; --diff -C
./play deploy-&lt;component&gt;.yml -l &lt;hostname&gt; --diff</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
any minor error in configuration files or ansible&#8217;s playbooks can be destructive for the backend infrastructure. Always test-run playbooks with <code>--diff</code> and <code>-C</code> at first and carefully verify configuration changes. After verification run the playbook without <code>-C</code> and verify again the applied changes.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<a href="#tool:etckeeper">Etckeeper</a> can be useful to verify configuration changes from a different point of view.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Some notable parts of the repository:</p>
</div>
<div class="paragraph">
<p>A list of the backend hosts lives at <a href="https://github.com/ooni/sysadmin/blob/master/ansible/inventory.yml" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/inventory.yml</a></p>
</div>
<div class="paragraph">
<p>The backend deployment playbook lives at <a href="https://github.com/ooni/sysadmin/blob/master/ansible/deploy-backend.yml" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/deploy-backend.yml</a></p>
</div>
<div class="paragraph">
<p>Many playbooks depend on roles that configure the OS, named <code>base-&lt;os_version&gt;</code>, for example:
<a href="https://github.com/ooni/sysadmin/blob/master/ansible/roles/base-bookworm" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/roles/base-bookworm</a> for Debian Bookworm and
<a href="https://github.com/ooni/sysadmin/tree/master/ansible/roles/base-bullseye" class="bare">https://github.com/ooni/sysadmin/tree/master/ansible/roles/base-bullseye</a> for Debian Bullseye</p>
</div>
<div class="paragraph">
<p>The nftables firewall is configured to read every <code>.nft</code> file under <code>/etc/ooni/nftables/</code> and <code>/etc/ooni/nftables/</code>.
This allows roles to create small files to open a port each and keep the configuration as close as possible to the ansible step that deploys a service. For example:
<a href="https://github.com/ooni/sysadmin/blob/master/ansible/roles/base-bookworm/tasks/main.yml#L110" class="bare">https://github.com/ooni/sysadmin/blob/master/ansible/roles/base-bookworm/tasks/main.yml#L110</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tool:etckeeper">Etckeeper</h3>
<div class="paragraph">
<p>Etckeeper <a href="https://etckeeper.branchable.com/" class="bare">https://etckeeper.branchable.com/</a> is deployed on backend hosts and keeps the <code>/etc</code> directory under git version control.
It commits automatically on package deployment and on timed runs.
It also allows doing commits manually.</p>
</div>
</div>
<div class="sect2">
<h3 id="_team_credential_repository">Team credential repository</h3>
<div class="paragraph">
<p>A private repository <a href="https://github.com/ooni/private" class="bare">https://github.com/ooni/private</a> contains team credentials, including username/password tuples, GPG keys and more.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
The credential file is GPG-encrypted as <code>credentials.json.gpg</code>. Do not commit the cleartext <code>credentials.json</code> file.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The credentials are stored in a JSON file to allow a flexible, hierarchical layout.
This allow storing metadata like descriptions on account usage, dates of account creations, expiry, and credential rotation time.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The tool checks JSON syntax and sorts keys automatically.</p>
</div>
<div class="sect3">
<h4 id="_listing_file_contents">Listing file contents</h4>
<div class="literalblock">
<div class="content">
<pre>git pull
make show</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_editing_contents">Editing contents</h4>
<div class="literalblock">
<div class="content">
<pre>git pull
make edit
git commit credentials.json.gpg -m "&lt;message&gt;"
git push</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_extracting_a_credential_programmatically">Extracting a credential programmatically:</h4>
<div class="literalblock">
<div class="content">
<pre>git pull
./extract 'grafana.username'</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
this can be used to automate credential retrieval from other tools, e.g. <a href="#tool:ansible">Ansible</a>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_updating_users_allowed_to_decrypt_the_credentials_file">Updating users allowed to decrypt the credentials file</h4>
<div class="paragraph">
<p>Edit <code>makefile</code> to add or remove recipients (see <code>--recipient</code>)</p>
</div>
<div class="paragraph">
<p>Then run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>git pull
make decrypt encrypt
git commit makefile credentials.json.gpg
git push</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_new_host_howto">New host HOWTO</h3>
<div class="ulist">
<ul>
<li>
<p>come up with a name for $name.ooni.tld based on the <a href="#dnspol">DNS naming policy</a></p>
</li>
<li>
<p>create a VM to allocate IP address</p>
</li>
<li>
<p>create <code>A</code> and <code>AAAA</code> records for the domain name in Namecheap web UI</p>
</li>
<li>
<p>fetch external inventory with <code>./play ext-inventory.yml</code>, it&#8217;ll create a git commit</p>
</li>
<li>
<p>add <code>&lt;name&gt;.ooni.&lt;tld&gt;</code> to <em>location tags</em> section of <code>inventory</code> file, git-commit it</p>
</li>
<li>
<p>bootstrap VM with <code>./play dom0-bootstrap.yml -l $name.ooni.tld --diff</code></p>
</li>
<li>
<p>update <a href="#tool:prometheus">Prometheus</a> with <code>./play deploy-prometheus.yml -t prometheus-conf --diff</code></p>
</li>
<li>
<p>check <code>inventory</code> sanity with <code>./play inventory-check.yml</code> (everything should be <code>ok</code>, no changes, no failures), update <code>inventory-check.yml</code> with new checksum, git-commit it</p>
</li>
<li>
<p><code>git push</code> those commits</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dns">DNS and Domains</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The primary domains used by the backend are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ooni.org</p>
</li>
<li>
<p>ooni.io</p>
</li>
<li>
<p>ooni.nu</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="dnspol">DNS naming policy</h3>
<div class="paragraph">
<p>Public-facing HTTPS services are named <code>${service}.ooni.org</code> or <code>${service}.ooni.io</code>
(legacy). Public-facing means the FQDNs are used directly by external users, services, or embedded in the probes.
They cannot be changed or retired without causing outages.</p>
</div>
<div class="paragraph">
<p>Give hosts private names and use only those in <code>inventory_hostname</code> to ease migrations.</p>
</div>
<div class="paragraph">
<p>VMs should have FQDN like <code>&lt;name&gt;-&lt;location&gt;[-&lt;number&gt;].ooni.org</code>.
VMs can provide one or more public-facing services that can change over time.
The name should be as descriptive as possible e.g. the type of services
or the most important service being run.</p>
</div>
<div class="paragraph">
<p><a href="#comp:test-helpers">Test helpers</a> have a special naming policy and are deployed by <a href="#rotation">Test helper rotation</a></p>
</div>
<div class="paragraph">
<p>Various legacy names should be cleaned up during re-deploying VMs with newer base OS version.</p>
</div>
</div>
<div class="sect2">
<h3 id="_dns_diagrams">DNS diagrams</h3>
<div class="sect3">
<h4 id="_a">A:</h4>
<div class="paragraph">
<p>See <a href="https://raw.githubusercontent.com/ooni/sysadmin/master/ext/dnsgraph.A.svg" class="bare">https://raw.githubusercontent.com/ooni/sysadmin/master/ext/dnsgraph.A.svg</a></p>
</div>
<div class="paragraph">
<p>The image is not included here due to space constraints.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cname">CNAME:</h4>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/ooni/sysadmin/master/ext/dnsgraph.CNAME.svg" alt="CNAME" width="700">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_mx">MX:</h4>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/ooni/sysadmin/master/ext/dnsgraph.MX.svg" alt="MX" width="500">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ns">NS:</h4>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/ooni/sysadmin/master/ext/dnsgraph.NS.svg" alt="NS" width="400">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_txt">TXT:</h4>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/ooni/sysadmin/master/ext/dnsgraph.TXT.svg" alt="TXT" width="1100">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_http_moved_permanently_http_code_301">HTTP Moved Permanently (HTTP code 301):</h4>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/ooni/sysadmin/master/ext/dnsgraph.URL301.svg" alt="URL301" width="700">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_http_redirects">HTTP Redirects:</h4>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/ooni/sysadmin/master/ext/dnsgraph.URL.svg" alt="URL" width="700">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_updating_dns_diagrams">Updating DNS diagrams</h4>
<div class="paragraph">
<p>To update the diagrams use the sysadmin repository:</p>
</div>
<div class="paragraph">
<p>Update the <code>./ext/dns.json</code> file:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>cd ansible
./play ext-inventory.yml -t namecheap
cd ..</pre>
</div>
</div>
<div class="paragraph">
<p>Then run <a href="https://github.com/ooni/sysadmin/blob/master/scripts/dnsgraph" class="bare">https://github.com/ooni/sysadmin/blob/master/scripts/dnsgraph</a> to generate the charts:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./scripts/dnsgraph</pre>
</div>
</div>
<div class="paragraph">
<p>It will generate SVG files under the <code>./ext/</code> directory.
Finally, commit and push the dns.json and SVG files.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operations">Operations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section contains howtos and runbooks on how to manage and update the backend.</p>
</div>
<div class="sect2">
<h3 id="_build_deploy_rollback">Build, deploy, rollback</h3>
<div class="paragraph">
<p>Host deployments are done with the <a href="https://github.com/ooni/sysadmin">sysadmin repo</a></p>
</div>
<div class="paragraph">
<p>For component updates a deployment pipeline is used:</p>
</div>
<div class="paragraph">
<p>Look at the [Status dashboard](<a href="https://github.com/ooni/backend/wiki/Backend" class="bare">https://github.com/ooni/backend/wiki/Backend</a>) - be aware of badge image caching</p>
</div>
</div>
<div class="sect2">
<h3 id="deployer">The deployer tool</h3>
<div class="paragraph">
<p>Deployments can be performed with a tool that acts as a frontend for APT.
It implements a simple Continuous Delivery workflow from CLI.
It does not require running a centralized CD pipeline server (e.g. like <a href="https://www.gocd.org/" class="bare">https://www.gocd.org/</a>)</p>
</div>
<div class="paragraph">
<p>The tool is hosted on the backend repository together with its configuration file for simplicity:
<a href="https://github.com/ooni/backend/blob/master/deployer" class="bare">https://github.com/ooni/backend/blob/master/deployer</a></p>
</div>
<div class="paragraph">
<p>At start time it traverses the path from the current working directory back to root until it finds a configuration file named deployer.ini
This allows using different deployement pipelines stored in configuration files across different repositories and subdirectories.</p>
</div>
<div class="paragraph">
<p>The tool connects to the hosts to perform deployments and requires sudo rights.
It installs Debian packages from repositories already configured on the hosts.</p>
</div>
<div class="paragraph">
<p>It runs <code>apt-get update</code> and then <code>apt-get install &#8230;&#8203;</code> to update or rollback packages.
By design, it does not interfere with manual execution of apt-get or through tools like <a href="#tool:ansible">Ansible</a>.
This means operators can log on a host to do manual upgrade or rollback of packages without breaking the deployer tool.</p>
</div>
<div class="paragraph">
<p>The tool depends only on the <code>python3-apt</code> package.</p>
</div>
<div class="paragraph">
<p>Here is a configuration file example, with comments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ini" data-lang="ini">[environment]
# Location on the path where SVG badges are stored
badges_path = /var/www/package_badges

# List of packages that are handled by the deployer, space separated
deb_packages = ooni-api fastpath analysis detector

# List of deployment stage names, space separated, from the least to the most critical
stages = test hel prod

# For each stage a block named stage:&lt;stage_name&gt; is required.
# The block lists the stage hosts.

# Example of an unused stage (not list under stages)
[stage:alpha]
hosts = localhost

[stage:test]
hosts = ams-pg-test.ooni.org

[stage:hel]
hosts = backend-hel.ooni.org

[stage:prod]
hosts = backend-fsn.ooni.org</code></pre>
</div>
</div>
<div class="paragraph">
<p>By running the tool without any argument it will connect to the hosts from the configuration file and print a summary of the installed packages, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ deployer

     Package               test                   prod
ooni-api               1.0.79~pr751-194       1.0.79~pr751-194
fastpath               0.81~pr748-191     ►►  0.77~pr705-119
analysis               1.9~pr659-61       ⚠   1.10~pr692-102
detector               0.3~pr651-98           0.3~pr651-98</code></pre>
</div>
</div>
<div class="paragraph">
<p>The green arrows between two package versions indicates that the version on the left side is higher than the one on the right side. This means that a rollout is pending.
In the example the fastpath package on the "prod" stage can be updated.</p>
</div>
<div class="paragraph">
<p>A red warning sign indicates that the version on the right side is higher than the one on the left side.
During a typical continuous deployment workflow version numbers should always increment
The rollout should go from left to right, aka from the least critical stage to the most critical stage.</p>
</div>
<div class="paragraph">
<p>Deploy/rollback a given version on the "test" stage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./deployer deploy ooni-api test 0.6~pr194-147</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deploy latest build on the first stage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./deployer deploy ooni-api</code></pre>
</div>
</div>
<div class="paragraph">
<p>Deploy latest build on a given stage. This usage is not recommended as it deploys the latest build regardless of what is currently running on previous stages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./deployer deploy ooni-api prod</code></pre>
</div>
</div>
<div class="paragraph">
<p>The deployer tool can also generate SVG badges that can then served by <a href="#comp:nginx">Nginx</a> or copied elsewhere to create a status dashboard.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/badge.png" alt="badge">
</div>
</div>
<div class="paragraph">
<p>Update all badges with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">./deployer refresh_badges</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_new_tests">Adding new tests</h3>
<div class="paragraph">
<p>To add support for a new test in the <a href="#comp:fastpath">Fastpath</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Update <a href="https://github.com/ooni/backend/blob/master/fastpath/fastpath/core.py">fastpath core</a> to add a scoring function.
See for example <code>def score_torsf(msm: dict) &#8594; dict:</code></p>
</div>
<div class="paragraph">
<p>Also add an <code>if</code> block to the <code>def score_measurement(msm: dict) &#8594; dict:</code> function to call the newly created function.</p>
</div>
<div class="paragraph">
<p>Finally, add</p>
</div>
<div class="paragraph">
<p>by adding a new test to the <code>score_measurement</code> function and adding relevant
integration tests.</p>
</div>
<div class="paragraph">
<p>Create a [Pull Request](<a href="https://github.com/ooni/pipeline/compare" class="bare">https://github.com/ooni/pipeline/compare</a>)</p>
</div>
<div class="paragraph">
<p>Run fastpath manually from S3 on the testing stage see: [rerun fastpath manually](#rerun-fastpath-manually)</p>
</div>
<div class="paragraph">
<p>Update the <a href="https://github.com/ooni/api/blob/master/newapi/ooniapi/measurements.py#L491">api</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_new_fingerprints">Adding new fingerprints</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_api_runbook">API runbook</h3>
<div class="paragraph">
<p>In order to deploy the API:</p>
</div>
<div class="paragraph">
<p>Monitor the <a href="#dash:api_fp">API and fastpath dashboard</a>. Review past weeks for any anomaly before starting a deployment.</p>
</div>
<div class="paragraph">
<p>Review the <a href="#comp:api">ooni-api</a> package changelog.</p>
</div>
<div class="paragraph">
<p>Ensure that either the database schema is consistent with the new deployement by creating tables and columns manually, or that the new codebase is automatically updating the database.</p>
</div>
<div class="paragraph">
<p>Quicly check past logs.</p>
</div>
<div class="paragraph">
<p>Follow Nginx and API logs with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">sudo journalctl -f --no-hostname</code></pre>
</div>
</div>
<div class="paragraph">
<p>While monitoring the logs, deploy the ooni-api package using the <a href="#deployer">The deployer tool</a> tool. (Details on the tool subchapter)</p>
</div>
<div class="paragraph">
<p>Manually check Explorer and other UIs as needed.</p>
</div>
</div>
<div class="sect2">
<h3 id="howto:db_query">Running database queries</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="howto:tor-targets">Updating tor targets</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="howto:api_accounts">Creating API accounts</h3>
<div class="paragraph">
<p>The API provides entry points to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://api.ooni.io/apidocs/#/default/get_api_v1_get_account_role__email_address_">get role</a></p>
</li>
<li>
<p><a href="https://api.ooni.io/apidocs/#/default/post_api_v1_set_account_role">set role</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The latter is implemented <a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/api/ooniapi/auth.py#L437">here</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The default value for API accounts is <code>user</code>. For such accounts there is no need for a record in the <code>accounts</code> table.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To change roles it is required to be authenticated and have a role as <code>admin</code>.</p>
</div>
<div class="paragraph">
<p>It is also possible to create or update roles by running SQL queries directly on <a href="#comp:clickhouse">ClickHouse</a>.
This can be necessary to create the initial <code>admin</code> account on a new deployment stage.</p>
</div>
<div class="paragraph">
<p>A quick way to identify the account ID an user is to extract logs from the <a href="#comp:api">API</a> either from the backend host or using <a href="#nb:logs">Logs from FSN notebook</a></p>
</div>
<div class="literalblock">
<div class="content">
<pre>backend-fsn:~$ sudo journalctl --since '5 min ago' -u ooni-api | grep 'SELECT role FROM accounts WHERE account_id' -C5</pre>
</div>
</div>
<div class="paragraph">
<p>Example output:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Nov 09 16:03:00 backend-fsn ooni-api[1763457]: DEBUG Query: SELECT role FROM accounts WHERE account_id = '&lt;redacted&gt;'</pre>
</div>
</div>
<div class="paragraph">
<p>federico@ams-pg-test:~$ clickhouse-client</p>
</div>
<div class="paragraph">
<p>Then insert a record to give`admin` role to the user. See <a href="#howto:db_query">Running database queries</a>:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>INSERT INTO accounts (account_id, role) VALUES ('&lt;redacted&gt;', 'admin')</pre>
</div>
</div>
<div class="paragraph">
<p><code>accounts</code> is an EmbeddedRocksDB table with <code>account_id</code> as primary key. No record deduplication is necessary.</p>
</div>
<div class="paragraph">
<p>To access the new role the user has to log out from web UIs and login again.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Account IDs are not the same across test and production instances.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is due to the use of a configuration variable <code>ACCOUNT_ID_HASHING_KEY</code> in the hashing of the email address. The parameter is read from the API configuration file. The values are different across deployment stages as a security feature.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fastpath_runbook">Fastpath runbook</h3>
<div class="sect3">
<h4 id="_fastpath_manual_deployment">Fastpath manual deployment</h4>
<div class="paragraph">
<p>You can use the <a href="#deployer">The deployer tool</a> tool to perform deployment and rollbacks. Sometimes it can be useful to run APT directly:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ssh &lt;host&gt;
sudo apt-get update
apt-cache show fastpath | grep Ver | head -n5
sudo apt-get install fastpath=&lt;version&gt;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
the fastpath is configured <strong>not</strong> to restart automatically during depolyment.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Always monitor logs and restart it as needed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo systemctl restart fastpath</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rerun_fastpath_manually">Rerun fastpath manually</h4>
<div class="paragraph">
<p>Reprocess old measurement by running the fastpath manually. This can be done without shutting down the fastpath instance running on live measurements.</p>
</div>
<div class="paragraph">
<p>You can run the fastpath as root or using the fastpath user. Both users are able to read the configuration file under <code>/etc/ooni</code>. The fastpath will download <a href="#topic:postcans">Postcan files</a> in the local directory.</p>
</div>
<div class="paragraph">
<p><code>fastpath -h</code> generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>usage:
OONI Fastpath

See README.adoc

 [-h] [--start-day START_DAY] [--end-day END_DAY]
                                         [--devel] [--noapi] [--stdout] [--debug]
                                         [--db-uri DB_URI]
                                         [--clickhouse-url CLICKHOUSE_URL] [--update]
                                         [--stop-after STOP_AFTER] [--no-write-to-db]
                                         [--keep-s3-cache] [--ccs CCS]
                                         [--testnames TESTNAMES]

options:
  -h, --help            show this help message and exit
  --start-day START_DAY
  --end-day END_DAY
  --devel               Devel mode
  --noapi               Process measurements from S3 and do not start API feeder
  --stdout              Log to stdout
  --debug               Log at debug level
  --clickhouse-url CLICKHOUSE_URL
                        ClickHouse url
  --stop-after STOP_AFTER
                        Stop after feeding N measurements from S3
  --no-write-to-db      Do not insert measurement in database
  --ccs CCS             Filter comma-separated CCs when feeding from S3
  --testnames TESTNAMES
                        Filter comma-separated test names when feeding from S3 (without
                        underscores)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To run the fastpath manually use:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ssh &lt;host&gt;
sudo sudo -u fastpath /bin/bash</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>fastpath --help
fastpath --start-day 2023-08-14 --end-day 2023-08-19 --noapi --stdout</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>--no-write-to-db</code> option can be useful for testing.</p>
</div>
<div class="paragraph">
<p>The <code>--ccs</code> and <code>--testnames</code> flags are useful to selectively reprocess measurements.</p>
</div>
<div class="paragraph">
<p>After reprocessing measurements it&#8217;s recommended to manually deduplicate the contents of the <code>fastpath</code> table. See <a href="#howto:fp_dedupe">Fastpath deduplication</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
it is possible to run multiple <code>fastpath</code> processes using <a href="https://www.gnu.org/software/parallel/" class="bare">https://www.gnu.org/software/parallel/</a> with different time ranges. Running the reprocessing under <code>byobu</code> is recommended.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The fastpath will pull <a href="#topic:postcans">Postcan files</a> from S3.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fastpath_monitoring">Fastpath monitoring</h4>
<div class="paragraph">
<p>Monitor real-time process using:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo journalctl -f -u fastpath</pre>
</div>
</div>
<div class="paragraph">
<p>Also the <a href="#dash:api_fp">Fastpath dashboard</a> and</p>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>See the <code>makefile</code> file for useful commands.</p>
</div>
<div class="paragraph">
<p>Run unit tests locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">make functests</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run devel mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">make run_devel</code></pre>
</div>
</div>
<div class="paragraph">
<p>Monitor logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">journalctl -f -t fastpath --utc -o short-precise

# show fields
journalctl -f -t fastpath  -N | sort

# filter by field, e.g.:
journalctl -f -t fastpath --utc CODE_LINE=12</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>Monitor metrics locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">make local_monitor_metrics</code></pre>
</div>
</div>
<div class="paragraph">
<p>In development mode, ~ is treated as /</p>
</div>
<div class="paragraph">
<p>Run development mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>fastpath --devel --start-day=2019-7-20 --end-day=2019-7-21</code></pre>
</div>
</div>
<div class="paragraph">
<p>TODO jupyter</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="apr_runb">Android probe release runbook</h3>
<div class="paragraph">
<p>This runbook is meant to help coordinate Android probe releases between the probe and backend developers and public announcements.
It does not contain detailed instructions for individual components.</p>
</div>
<div class="paragraph">
<p>Roles: @probe, @backend, @media</p>
</div>
<div class="sect3">
<h4 id="_android_pre_release">Android pre-release</h4>
<div class="paragraph">
<p>@probe: drive the process involving the other teams as needed. Create calendar events to track the next steps. Run the probe checklist <a href="https://docs.google.com/document/d/1S6X5DqVd8YzlBLRvMFa4RR6aGQs8HSXfz8oGkKoKwnA/edit" class="bare">https://docs.google.com/document/d/1S6X5DqVd8YzlBLRvMFa4RR6aGQs8HSXfz8oGkKoKwnA/edit</a></p>
</div>
<div class="paragraph">
<p>@backend: review <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_android_probe_release.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_android_probe_release.html</a> and <a href="https://grafana.ooni.org/d/l-MQSGonk/api-and-fastpath-multihost?orgId=1&amp;refresh=5s&amp;var-avgspan=8h&amp;var-host=backend-fsn.ooni.org&amp;from=now-30d&amp;to=now" class="bare">https://grafana.ooni.org/d/l-MQSGonk/api-and-fastpath-multihost?orgId=1&amp;refresh=5s&amp;var-avgspan=8h&amp;var-host=backend-fsn.ooni.org&amp;from=now-30d&amp;to=now</a> for long-term trends</p>
</div>
</div>
<div class="sect3">
<h4 id="_android_release">Android release</h4>
<div class="paragraph">
<p>@probe: release the probe for early adopters</p>
</div>
<div class="paragraph">
<p>@backend: monitor <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_android_probe_release.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_android_probe_release.html</a> frequently during the first 24h and report any drop on Slack</p>
</div>
<div class="paragraph">
<p>@probe: wait at least 24h then release the probe for all users</p>
</div>
<div class="paragraph">
<p>@backend: monitor <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_android_probe_release.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_android_probe_release.html</a> daily for 14 days and report any drop on Slack</p>
</div>
<div class="paragraph">
<p>@probe: wait at least 24h then poke @media to announce the release</p>
</div>
<div class="paragraph">
<p>(<a href="https://github.com/ooni/backend/wiki/Runbooks:-Android-Probe-Release" class="bare">https://github.com/ooni/backend/wiki/Runbooks:-Android-Probe-Release</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="clip_runb">CLI probe release runbook</h3>
<div class="paragraph">
<p>This runbook is meant to help coordinate CLI probe releases between the probe and backend developers and public announcements.
It does not contain detailed instructions for individual components.</p>
</div>
<div class="paragraph">
<p>Roles: @probe, @backend, @media</p>
</div>
<div class="sect3">
<h4 id="_cli_pre_release">CLI pre-release</h4>
<div class="paragraph">
<p>@probe: drive the process involving the other teams as needed. Create calendar events to track the next steps. Run the probe checklist and review the CI.</p>
</div>
<div class="paragraph">
<p>@backend: review [jupyter](<a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_cli_probe_release.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_cli_probe_release.html</a>) and [grafana](<a href="https://grafana.ooni.org/d/l-MQSGonk/api-and-fastpath-multihost?orgId=1&amp;refresh=5s&amp;var-avgspan=8h&amp;var-host=backend-fsn.ooni.org&amp;from=now-30d&amp;to=now" class="bare">https://grafana.ooni.org/d/l-MQSGonk/api-and-fastpath-multihost?orgId=1&amp;refresh=5s&amp;var-avgspan=8h&amp;var-host=backend-fsn.ooni.org&amp;from=now-30d&amp;to=now</a>) for long-term trends</p>
</div>
</div>
<div class="sect3">
<h4 id="_cli_release">CLI release</h4>
<div class="paragraph">
<p>@probe: release the probe for early adopters</p>
</div>
<div class="paragraph">
<p>@backend: monitor [jupyter](<a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_cli_probe_release.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_cli_probe_release.html</a>) frequently during the first 24h and report any drop on Slack</p>
</div>
<div class="paragraph">
<p>@probe: wait at least 24h then release the probe for all users</p>
</div>
<div class="paragraph">
<p>@backend: monitor [jupyter](<a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_cli_probe_release.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_cli_probe_release.html</a>) daily for 14 days and report any drop on Slack</p>
</div>
<div class="paragraph">
<p>@probe: wait at least 24h then poke @media to announce the release</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_debian_packages">Debian packages</h3>
<div class="paragraph">
<p>This section lists the Debian packages used to deploy backend components.
They are built by <a href="#gh_actions">GitHub CI workflows</a> and deployed using <a href="#deployer">The deployer tool</a>.
See <a href="#deb_build">Debian package build and publish</a>.</p>
</div>
<div class="sect3">
<h4 id="pkg:ooni-api">ooni-api package</h4>
<div class="paragraph">
<p>Debian package for the <a href="#comp:api">API</a></p>
</div>
</div>
<div class="sect3">
<h4 id="pkg:fastpath">fastpath package</h4>
<div class="paragraph">
<p>Debian package for the <a href="#comp:fastpath">Fastpath</a></p>
</div>
</div>
<div class="sect3">
<h4 id="pkg:detector">detector package</h4>
<div class="paragraph">
<p>Debian package for the <a href="#detector">Social media blocking event detector</a></p>
</div>
</div>
<div class="sect3">
<h4 id="pkg:analysis">analysis package</h4>
<div class="paragraph">
<p>The <code>analysis</code> Debian package contains various tools and runs various of systemd timers, see <a href="#sys_timers">Systemd timers</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_analysis_deployment">Analysis deployment</h4>

</div>
<div class="sect3">
<h4 id="_run_manually">Run manually</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo systemctl restart ooni-update-counters.service</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_log_monitoring">Log monitoring</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>sudo journalctl -f --identifier analysis</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_monitoring_dashboard">Monitoring dashboard</h4>
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_new_host">Deploy new host</h3>
<div class="paragraph">
<p>Deploy host from <a href="https://cloud.digitalocean.com/projects/" class="bare">https://cloud.digitalocean.com/projects/</a></p>
</div>
<div class="paragraph">
<p>Create DNS "A" record <code>&lt;name&gt;.ooni.org</code> at <a href="https://ap.www.namecheap.com/" class="bare">https://ap.www.namecheap.com/</a></p>
</div>
<div class="paragraph">
<p>On the sysadmin repository, in the <code>ansible</code> directory, add the host to the inventory</p>
</div>
<div class="paragraph">
<p>Run the deploy with the root SSH user</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>./play deploy-&lt;foo&gt;.yml -l &lt;name&gt;.ooni.org --diff -u root</code></pre>
</div>
</div>
<div class="paragraph">
<p>Update <a href="#tool:prometheus">Prometheus</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>./play deploy-prometheus.yml -t prometheus-conf --diff</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backend_components">Backend components</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="uploader">API Measurement uploader</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Uploads fresh measurements to S3 after compressing them into postcans and .jsonl files
Reads /etc/ooni/api.conf</p>
</div>
<div class="paragraph">
<p>See the <a href="#dash:uploader">uploader dashboard</a> and <a href="#timer:uploader">uploader timer</a></p>
</div>
<div class="sect2">
<h3 id="topic:postcans">Postcan files</h3>
<div class="paragraph">
<p>A “postcan” is tarball containing measurements as they are uploaded by the probes, optionally compressed.
Postcans are meant for internal use.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="s3_msmt">S3 measurement files layout</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>ooni-data-eu-fra</code> Amazon S3 bucket contains the whole OONI dataset.</p>
</div>
<div class="paragraph">
<p>Probes usually upload multiple measurements on each execution. Measurements are stored temporarily and then batched together, compressed and uploaded to the S3 bucket once every hour. To ensure transparency, incoming measurements go through basic content validation and the API returns success or error; once a measurement is accepted it will be published on S3.</p>
</div>
<div class="paragraph">
<p>Specifications of the raw measurement data can be found inside of the <code>ooni/spec</code> repository.</p>
</div>
<div class="sect2">
<h3 id="topic:jsonl">JSONL files</h3>
<div class="paragraph">
<p>File paths in the S3 bucket in JSONL format.</p>
</div>
<div class="paragraph">
<p>Contains a JSON document for each measurement, separated by newline and compressed, for faster processing.
The JSONL format is natively supported by various data science tools and libraries.</p>
</div>
<div class="paragraph">
<p>The path structure allows to easily select, identify and download data based on the researcher’s needs.</p>
</div>
<div class="paragraph">
<p>In the path template:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cc</code> is an uppercase 2 letter country code</p>
</li>
<li>
<p><code>testname</code> is a test name where underscores are removed</p>
</li>
<li>
<p><code>timestamp</code> is a YYYYMMDD timestamp</p>
</li>
<li>
<p><code>name</code> is a unique filename</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_compressed_jsonl_from_measurements_before_20201021">Compressed JSONL from measurements before 20201021</h4>
<div class="paragraph">
<p>The path structure is: <code>s3://ooni-data-eu-fra/jsonl/&lt;testname&gt;/&lt;cc&gt;/&lt;timestamp&gt;/00/&lt;name&gt;.jsonl.gz</code></p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>s3://ooni-data-eu-fra/jsonl/webconnectivity/IT/20200921/00/20200921_IT_webconnectivity.l.0.jsonl.gz</pre>
</div>
</div>
<div class="paragraph">
<p>You can list JSONL files with:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>s3cmd ls s3://ooni-data-eu-fra/jsonl/
s3cmd ls s3://ooni-data-eu-fra/jsonl/webconnectivity/US/20201021/00/</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compressed_jsonl_from_measurements_starting_from_20201020">Compressed JSONL from measurements starting from 20201020</h4>
<div class="paragraph">
<p>The path structure is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>s3://ooni-data-eu-fra/raw/&lt;timestamp&gt;/&lt;hour&gt;/&lt;cc&gt;/&lt;testname&gt;/&lt;ts2&gt;_&lt;cc&gt;_&lt;testname&gt;.&lt;host_id&gt;.&lt;counter&gt;.jsonl.gz</pre>
</div>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>s3://ooni-data-eu-fra/raw/20210817/15/US/webconnectivity/2021081715_US_webconnectivity.n0.0.jsonl.gz</pre>
</div>
</div>
<div class="paragraph">
<p>Note: The path will be updated in the future to live under <code>/jsonl/</code></p>
</div>
<div class="paragraph">
<p>You can list JSONL files with:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>s3cmd ls s3://ooni-data-eu-fra/raw/20210817/15/US/webconnectivity/</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_raw_postcans_from_measurements_starting_from_20201020">Raw “postcans” from measurements starting from 20201020</h4>
<div class="paragraph">
<p>Each HTTP POST is stored in the tarball as <code>&lt;timestamp&gt;_&lt;cc&gt;_&lt;testname&gt;/&lt;timestamp&gt;_&lt;cc&gt;_&lt;testname&gt;_&lt;hash&gt;.post</code></p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>s3://ooni-data-eu-fra/raw/20210817/11/GB/webconnectivity/2021081711_GB_webconnectivity.n0.0.tar.gz</pre>
</div>
</div>
<div class="paragraph">
<p>Listing postcan files:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>s3cmd ls s3://ooni-data-eu-fra/raw/20210817/
s3cmd ls s3://ooni-data-eu-fra/raw/20210817/11/GB/webconnectivity/</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_components_todo">Components: TODO</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="https://kroki.io/blockdiag/svg/eNpLyslPzk7JTExXqOZSUAo2Vsgqzs_LUVKILs5ILEhVsFVIzcnJLChOjbWGSBfkF5ckJ-YV41CRklmcrVBYmlqail1BQFF-Umqxgq6dgmOAJ4hC0QHklxbk5CempBaB5eDOAepEl4A7xJoLbmx0cn5OfhHQRiXltLRUIFAC2lkLAFH1R1M=" alt="Diagram">
</div>
</div>
<div class="sect2">
<h3 id="comp:nginx">Nginx</h3>
<div class="paragraph">
<p>Nginx <a href="https://www.nginx.com/" class="bare">https://www.nginx.com/</a> is used across various servers in the backend, primarily as a reverse proxy.
It&#8217;s worth summarizing the main different uses here:
 * Reverse proxy for the <a href="#comp:api">API</a>, also providing <strong>caching</strong> from many API methods
 * Serving local measurements from disk from the backend hosts
 * Serving Atom/RSS feeds from disk from the backend hosts
 * Serving ACME challenge text files for <a href="#comp:dehydrated">Dehydrated</a>
 * Reverse proxy for the test helpers
 * Reverse proxy for deb.ooni.org
 * Reverse proxy for internal or ancilliary services e.g. <a href="#tool:prometheus">Prometheus</a> scraping, <a href="#tool:grafana">Grafana</a> etc</p>
</div>
<div class="paragraph">
<p>Nginx configuration files are stored in <a href="https://github.com/ooni/sysadmin/tree/master/ansible" class="bare">https://github.com/ooni/sysadmin/tree/master/ansible</a></p>
</div>
<div class="paragraph">
<p>Most of the proxying functionalities of Nginx can be replaced with <a href="#comp:haproxy">Haproxy</a> to benefit from load balancing and active checks.</p>
</div>
<div class="paragraph">
<p>Caching could be provided by Varnish <a href="https://varnish-cache.org/" class="bare">https://varnish-cache.org/</a> as it provides the ability to explicity purge caches. This would be useful when testing the API.</p>
</div>
<div class="sect3">
<h4 id="_purging_nginx_cache">Purging Nginx cache</h4>
<div class="paragraph">
<p>While testing the API it can be useful to purge the cache provide by Nginx.</p>
</div>
<div class="paragraph">
<p>This selectively removes the cache files used for the API:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>rm /var/cache/nginx/ooni-api/* -rf</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
This method is not natively supported by Nginx. It&#8217;s recommended to use it only on the backend testbed.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comp:haproxy">Haproxy</h3>
<div class="paragraph">
<p>Haproxy runs on the bridges and works as a load balancer for the test helpers and the APIs on ams-pg-test.ooni.org, backend-hel.ooni.org and the bridge on bridge-greenhost.ooni.org</p>
</div>
<div class="paragraph">
<p>Contrasted to <a href="#comp:nginx">Nginx</a> it&#8217;s focused on load balancing rather than serving files.
It provides dashboards showing the current status of the web services and the load balancing targets:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://bridge-greenhost.ooni.org:444/__haproxy_stats" class="bare">https://bridge-greenhost.ooni.org:444/__haproxy_stats</a></p>
</li>
<li>
<p><a href="https://backend-hel.ooni.org:444/__haproxy_stats" class="bare">https://backend-hel.ooni.org:444/__haproxy_stats</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example of the built-in dashboard:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/haproxy.png" alt="haproxy">
</div>
</div>
<div class="paragraph">
<p>When providing load balancing for the <a href="#comp:test-helpers">Test helpers</a> it uses a stateful algorithm based on the source IP address to ensure that every given probe reaches the same test helper.
This is meant to help troubleshooting.
Yet, in case a test helper becomes unreachable probe traffic is sent to the remaining test helpers.
This affects exclusively the probes that were using the unreachable test helper.
The probes that were reaching other test helpers are not shuffled around.</p>
</div>
</div>
<div class="sect2">
<h3 id="comp:dehydrated">Dehydrated</h3>
<div class="paragraph">
<p>Dehydrated provides Let&#8217;s Encrypt certificate handling using ACME. It replaces certbot with a simpler and more reliable implementation.</p>
</div>
<div class="paragraph">
<p>Dehydrated is configured in <a href="#tool:ansible">Ansible</a>, see <a href="https://github.com/ooni/sysadmin/tree/master/ansible/roles/dehydrated" class="bare">https://github.com/ooni/sysadmin/tree/master/ansible/roles/dehydrated</a></p>
</div>
<div class="paragraph">
<p>For monitoring see <a href="#dash:cert">TLS certificate dashboard</a>.
There are alerts configured in <a href="#tool:grafana">Grafana</a> to alert on expiring certificates, see <a href="#topic:alerting">Alerting</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="tool:jupyter">Jupyter Notebook</h3>
<div class="paragraph">
<p>There is an instance of Jupyter Notebook <a href="https://jupyter.org/" class="bare">https://jupyter.org/</a> deployed on the <a href="#host:monitoring">monitoring.ooni.org</a> available for internal use at <a href="https://jupyter.ooni.org/tree/notebooks" class="bare">https://jupyter.ooni.org/tree/notebooks</a></p>
</div>
<div class="paragraph">
<p>It is used primarily for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Performing research and data analysis using data science tools like <a href="https://pandas.pydata.org/">Pandas</a> and <a href="https://altair-viz.github.io/">Altair</a>.</p>
</li>
<li>
<p>Generating automatic dashboards using <a href="#tool:jupycron">Jupycron</a> and sending alerts.</p>
</li>
<li>
<p>Analyzing logs from the <a href="#comp:click_log">ClickHouse intance for logs</a></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
There in no user account support in Jupyter Notebook. The instance is protected by HTTP basic auth using team credentials. To clarify ownership of notebooks put your account name as part of the notebook name. To prevent data loss do not modify notebooks owned by other users.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="sect3">
<h4 id="ooutils">Ooniutils microlibrary</h4>
<div class="paragraph">
<p>The following notebook is often used as a library in other notebooks: <a href="https://jupyter.ooni.org/notebooks/notebooks/ooniutils.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/ooniutils.ipynb</a></p>
</div>
<div class="paragraph">
<p>It can be imported in other notebooks by adding this at the top:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>%run ooniutils.ipynb</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
be careful when making changes to it because it could break many notebooks including the ones automatically run by <a href="#tool:jupycron">Jupycron</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running the notebook imports commonly used libraries, including Pandas and Altair, configures Jupyter Notebook and provides some convenience functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>click_query_fsn(query, **params)</code> to run queries against ClickHouse on <a href="#host:FSN">backend-fsn.ooni.org</a>. Returns a Pandas dataframe.</p>
</li>
<li>
<p><code>alertmanager_fire_alert(summary, alertname, job="", instance="", annotations={}, duration_min=1)</code> to send an alert through alertmanager (<a href="#tool:grafana">Grafana</a>).</p>
</li>
<li>
<p><code>send_slack_msg(title, msg, color="3AA3E3")</code> to send messages directly to Slack.</p>
</li>
<li>
<p><code>send_alert_through_ntfy(title, msg, priority="urgent", tags="warning")</code> to send alerts directly using <a href="https://ntfy.sh/" class="bare">https://ntfy.sh/</a> - see <a href="#ntfy">Redundant notifications</a> for details.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
Confusingly, <code>alertmanager_fire_alert</code> needs an alarm duration to be set when called. <code>send_slack_msg</code> can be used in addition to provide more details and subsequent updates to an existing alert. Additionally, <code>send_slack_msg</code> can deliver clickable links.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
When creating new alerts it is helpful to include full links to the automated notebook generating the alert and its HTML output. See <a href="#tool:jupycron">Jupycron</a> for details.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="tool:jupycron">Jupycron</h4>
<div class="paragraph">
<p>Jupycron is a Python script that runs Jupyter notebooks automatically.</p>
</div>
<div class="paragraph">
<p>Various notebooks are used to perform analysing, reporting and alarming using data science tools that are more powerful than <a href="#tool:grafana">Grafana</a> and <a href="#tool:prometheus">Prometheus</a> internal query language.
An example is the use of <a href="https://scikit-learn.org">scikit-learn</a>'s machine learning for prediciting incoming measurement flow.
TODO link</p>
</div>
<div class="paragraph">
<p>It is internally developed and hosted on <a href="https://github.com/ooni/jupycron.git">github</a>.
It is deployed by <a href="#tool:ansible">Ansible</a> on <a href="#host:monitoring">monitoring.ooni.org</a>.</p>
</div>
<div class="paragraph">
<p>It runs every minute and scans the existing notebooks at <code>/var/lib/jupyter/notebooks/</code>.
It parses only notebooks that have the word <code>autorun</code> in the filename. (see example below)
It then scans the content of the notebook looking for a code cell that contains a commented line like:</p>
</div>
<div class="literalblock">
<div class="content">
<pre># jupycron: {"every": "30 minute"}</pre>
</div>
</div>
<div class="paragraph">
<p>If such line is found it executes the notebook according to the required time interval and stores the output as an HTML file at <code>/var/lib/jupyter/notebooks/jupycron</code></p>
</div>
<div class="paragraph">
<p>Execution intervals can be specified using keywords:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>"min", "hour", "day", "week", "month"</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The <code>AUTORUN</code> environment variable is set when a notebook is run under jupycron. Also <a href="#ooutils">Ooniutils microlibrary</a> sets the <code>autorun</code> Python variable to <code>True</code>. This can be useful to send alerts only when notebooks are being run automatically.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Jupycron also provides an HTML <a href="https://jupyter.ooni.org/view/notebooks/jupycron/summary.html">summary</a> of the existing automated notebooks.</p>
</div>
<div class="paragraph">
<p>The status column indicates the outcome of the previous run, if any:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>🟢: successful run</p>
</li>
<li>
<p>🔴: failed run</p>
</li>
<li>
<p>⌛: never executed before</p>
</li>
<li>
<p>🛇: disabled notebook: the <code># jupycron: {&#8230;&#8203;}</code> line was not found</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
notebooks are executed by <code>jupyter-nbconvert</code> under <code>systemd-run</code> with memory limits to protect the <a href="#host:monitoring">monitoring.ooni.org</a> host. The limit can be changed by setting a <code>MaxMem</code> key in the configuration line, in megabytes.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Debugging tip: Jupycron stores the history of notebook executions in <code>/var/lib/jupyter/notebooks/jupycron/.history.json</code>.</p>
</div>
<div class="paragraph">
<p>For an example of automated notebook that sends alarm see <a href="#th_fr_nb">Test helper failure rate notebook</a></p>
</div>
</div>
<div class="sect3">
<h4 id="th_fr_nb">Test helper failure rate notebook</h4>
<div class="paragraph">
<p>This automated notebook performs a correlation of test failures and the location of test helpers.</p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_test_helper_failure_rate_alarm.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_test_helper_failure_rate_alarm.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_test_helper_failure_rate_alarm.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_test_helper_failure_rate_alarm.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_android_probe_release_notebook">Android probe release notebook</h4>
<div class="paragraph">
<p>This automated notebook is used to compare changes in incoming measurements across different versions of the Android probe.</p>
</div>
<div class="paragraph">
<p>It is used in the <a href="#apr_runb">Android probe release runbook</a></p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_android_probe_release.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_android_probe_release.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_android_probe_release.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_android_probe_release.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_ios_probe_release_notebook">iOS probe release notebook</h4>
<div class="paragraph">
<p>This automated notebook is used to compare changes in incoming measurements across different versions of the iOS probe.</p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_ios_probe_release.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_ios_probe_release.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_ios_probe_release.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_ios_probe_release.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_cli_probe_release_notebook">CLI probe release notebook</h4>
<div class="paragraph">
<p>This automated notebook performs Used to compare changes in incoming measurements across different versions of the CLI probe.</p>
</div>
<div class="paragraph">
<p>It is used in the <a href="#clip_runb">CLI probe release runbook</a></p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_cli_probe_release.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_cli_probe_release.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_cli_probe_release.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_cli_probe_release.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_duplicate_test_list_urls_notebook">Duplicate test-list URLs notebook</h4>
<div class="paragraph">
<p>This automated notebook shows duplicate URLs across global and per-country test lists</p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_duplicate_test_list_urls.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_duplicate_test_list_urls.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_duplicate_test_list_urls.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_duplicate_test_list_urls.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_monitor_blocking_event_detections_notebook">Monitor blocking event detections notebook</h4>
<div class="paragraph">
<p>This automated notebook monitor the <a href="#detector">Social media blocking event detector</a> creating a summary table with clickable links to events.
It also sends notification messages on Slack.</p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_event_detector_alerts.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_event_detector_alerts.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_event_detector_alerts.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_event_detector_alerts.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="nb:logs">Logs from FSN notebook</h4>
<div class="paragraph">
<p>This automated notebook provides summaries and examples of log analysys.</p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_fsn_logs.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_fsn_logs.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_fsn_logs.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_fsn_logs.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_incoming_measurements_prediction_and_alarming_notebook">Incoming measurements prediction and alarming notebook</h4>
<div class="paragraph">
<p>This automated notebook uses Sklearn to implement predictions of the incoming measurement flow using a linear regression.
It generates alarms if incoming traffic drops below a given threshold compared to the predicted value.</p>
</div>
<div class="paragraph">
<p>The purpose of the notebook is to detect major outages or any event affecting ooni&#8217;s infrastructure that causes significant loss in incoming traffic.</p>
</div>
<div class="paragraph">
<p>Predictions and runs work on a hourly basis and process different probe types independently.</p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_incoming_measurements_prediction_alarming.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_incoming_measurements_prediction_alarming.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_incoming_measurements_prediction_alarming.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_incoming_measurements_prediction_alarming.html</a></p>
</div>
<div class="paragraph">
<p>An example of measurement flow prediction:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/autorun_incoming_measurements_prediction_alarming.html.png" alt="prediction">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_incoming_measurements_prediction_by_country_notebook">Incoming measurements prediction-by-country notebook</h4>
<div class="paragraph">
<p>This automated notebook is similar to the previous one but evaluates each country independently.</p>
</div>
<div class="paragraph">
<p>The main purpose is to detect countries encountering significant Internet access disruption or blocking of ooni&#8217;s network traffic.</p>
</div>
<div class="paragraph">
<p>The notebook is currently work-in-progress and therefore monitoring few countries.</p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_incoming_measurements_prediction_alarming_per_country.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_incoming_measurements_prediction_alarming_per_country.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_incoming_measurements_prediction_alarming_per_country.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_incoming_measurements_prediction_alarming_per_country.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_long_term_measurements_prediction_notebook">Long term measurements prediction notebook</h4>
<div class="paragraph">
<p>This automated notebook runs long-term predictions of incoming measurement flows and alarms on significant drops.</p>
</div>
<div class="paragraph">
<p>The purpose is to detect <strong>slow</strong> decreases in measurements over time that have gone unnoticed in the past in similar situations.</p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_incoming_measurements_prediction_long_term_alarming.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_incoming_measurements_prediction_long_term_alarming.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_incoming_measurements_prediction_long_term_alarming.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_incoming_measurements_prediction_long_term_alarming.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_incoming_measurements_notebook">Incoming measurements notebook</h4>
<div class="paragraph">
<p>This automated notebook provides a dashboard of incoming measurement flows grouped by probe type, from a multiple-year point of view.</p>
</div>
<div class="paragraph">
<p>Its purpose is to provide charts to be reviewed by the team to discuss long term trends.</p>
</div>
<div class="paragraph">
<p>Notebook: <a href="https://jupyter.ooni.org/notebooks/notebooks/autorun_incoming_msmts.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/autorun_incoming_msmts.ipynb</a></p>
</div>
<div class="paragraph">
<p>Output: <a href="https://jupyter.ooni.org/view/notebooks/jupycron/autorun_incoming_msmts.html" class="bare">https://jupyter.ooni.org/view/notebooks/jupycron/autorun_incoming_msmts.html</a></p>
</div>
</div>
<div class="sect3">
<h4 id="nb:click_q">ClickHouse queries notebook</h4>
<div class="paragraph">
<p>This is a non-automated notebook used to summarize heavy queries in <a href="#comp:clickhouse">ClickHouse</a></p>
</div>
<div class="paragraph">
<p><a href="https://jupyter.ooni.org/notebooks/notebooks/2023%20%5Bfederico%5D%20clickhouse%20query%20log.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/2023%20%5Bfederico%5D%20clickhouse%20query%20log.ipynb</a></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The <code>system.query_log</code> table grows continuously and might be trimmed or emptied using <code>TRUNCATE</code> to free disk space.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tool:grafana">Grafana</h3>
<div class="paragraph">
<p>Grafana <a href="https://grafana.com/" class="bare">https://grafana.com/</a> is a popular platform for monitoring and alarming.</p>
</div>
<div class="paragraph">
<p>It is deployed on <a href="#host:monitoring">monitoring.ooni.org</a> by <a href="#tool:ansible">Ansible</a> and lives at
<a href="https://grafana.ooni.org/" class="bare">https://grafana.ooni.org/</a></p>
</div>
<div class="sect3">
<h4 id="howto:grafana_backup">Grafana backup</h4>
<div class="paragraph">
<p>The Grafana SQLite database can be dumped using:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>monitoring:~$ sqlite3 -line /var/lib/grafana/grafana.db '.dump' &gt; grafana_dump.sql</pre>
</div>
</div>
<div class="paragraph">
<p>Future implementation is tracked in:
<a href="https://github.com/ooni/backend/issues/770">Implement Grafana dashboard and alarms backup</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="comp:click_log">ClickHouse intance for logs</h3>
<div class="paragraph">
<p>There is an instance of ClickHouse deployed on <a href="#host:monitoring">monitoring.ooni.org</a> that receives logs.
See <a href="#logman">Log management</a> for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="tool:vector">Vector</h3>
<div class="paragraph">
<p>Vector <a href="https://vector.dev" class="bare">https://vector.dev</a> is a log (and metric) management tool. See <a href="#logman">Log management</a> for details.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Vector is not packaged in Debian yet. See <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1019316" class="bare">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1019316</a> Vector is currently installed using a 3rd party APT archive.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="comp:clickhouse">ClickHouse</h3>
<div class="paragraph">
<p>ClickHouse is main database that stores measurements and many other tables. It accessed primarily by the <a href="#comp:api">API</a> and the <a href="#comp:fastpath">Fastpath</a>.</p>
</div>
<div class="paragraph">
<p>It is an OLAP, columnar database. For documentation see <a href="https://clickhouse.com/docs/en/intro" class="bare">https://clickhouse.com/docs/en/intro</a></p>
</div>
<div class="paragraph">
<p>The database schema required by the API is stored in:
<a href="https://github.com/ooni/backend/blob/master/api/tests/integ/clickhouse_1_schema.sql" class="bare">https://github.com/ooni/backend/blob/master/api/tests/integ/clickhouse_1_schema.sql</a></p>
</div>
<div class="paragraph">
<p>ClickHouse is deployed by <a href="#tool:ansible">Ansible</a> as part of the deploy-backend.yml playbook. It is installed using an APT archive from the developers and</p>
</div>
<div class="paragraph">
<p>Related: <a href="#comp:db_backup">Database backup tool</a></p>
</div>
<div class="sect3">
<h4 id="_overall_design">Overall design</h4>
<div class="paragraph">
<p>The backend uses both the native ClickHouse table engine MergeTree and "foreign" database engines, for example in EmbeddedRocksDB tables.
The existing tables using MergeTree are meant to be support replication in future. This is crucial to implement active/standby and even active/active setups both for increased reliability and performance.</p>
</div>
<div class="paragraph">
<p>MergeTree is column-oriented, eventually consistent, non-transactional and optimized for large batches.
EmbeddedRocksDB is using <a href="https://rocksdb.org/" class="bare">https://rocksdb.org/</a> - a key-value, row-oriented, low-latency engine. Some backend workloads are more suitable for this engine.
NOTE: EmbeddedRocksDB currently does not support replication</p>
</div>
<div class="paragraph">
<p>To get an overview of the existing tables and engines use:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SELECT engine, name FROM system.tables WHERE database = 'default' ORDER BY engine, name</pre>
</div>
</div>
<div class="paragraph">
<p>An overview of the more important tables:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Metric_name</th>
<th class="tableblock halign-left valign-top">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">CollapsingMergeTree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:url_priorities">url_priorities table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EmbeddedRocksDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:accounts">accounts table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EmbeddedRocksDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:fingerprints_dns">fingerprints_dns table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EmbeddedRocksDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:fingerprints_dns_tmp">fingerprints_dns_tmp table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EmbeddedRocksDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:fingerprints_http">fingerprints_http table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EmbeddedRocksDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:fingerprints_http_tmp">fingerprints_http_tmp table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">EmbeddedRocksDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:session_expunge">session_expunge table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Join</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:test_groups">test_groups table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaterializedView</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:counters_asn_test_list">counters_asn_test_list table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MaterializedView</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:counters_test_list">counters_test_list table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergeTree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:asnmeta">asnmeta table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MergeTree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:jsonl">jsonl table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ReplacingMergeTree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:citizenlab">citizenlab table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ReplacingMergeTree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:citizenlab_flip">citizenlab_flip table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ReplacingMergeTree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:fastpath">fastpath table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ReplacingMergeTree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:incidents">incidents table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ReplacingMergeTree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:msmt_feedback">msmt_feedback table</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ReplacingMergeTree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="#tbl:oonirun">oonirun table</a></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
As ClickHouse does not support transactions, there are some workarounds to implement atomic updates.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One way is to use two tables with the same schema, where one table receive updates and another one is used for reading, and swap them once the writes are completed.
The SQL syntax is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>EXCHANGE TABLES &lt;a&gt; AND &lt;b&gt;</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:accounts">accounts table</h4>
<div class="paragraph">
<p>Used for authentication. Assignes roles to accounts (by account id).
The default value for accounts not present in the table is "user". As such, the table is currently tracking only admin roles.</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>CREATE TABLE default.accounts
(
    `account_id` FixedString(32),
    `role` String,
    `update_time` DateTime DEFAULT now()
)
ENGINE = EmbeddedRocksDB
PRIMARY KEY account_id</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create and update account roles see:</p>
</div>
<div class="paragraph">
<p><a href="#howto:api_accounts">Creating API accounts</a></p>
</div>
</div>
<div class="sect3">
<h4 id="tbl:asnmeta">asnmeta table</h4>
<div class="paragraph">
<p>Contains ASN lookup data used by the API</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.asnmeta
(
    `asn` UInt32,
    `org_name` String,
    `cc` String,
    `changed` Date,
    `aut_name` String,
    `source` String
)
ENGINE = MergeTree
ORDER BY (asn, changed)
SETTINGS index_granularity = 8192</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:asnmeta_tmp">asnmeta_tmp table</h4>
<div class="paragraph">
<p>Temporary table, see <a href="#tbl:asnmeta">asnmeta table</a></p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.blocking_events
(
    `test_name` String,
    `input` String,
    `probe_cc` String,
    `probe_asn` Int32,
    `status` String,
    `time` DateTime64(3),
    `detection_time` DateTime64(0) MATERIALIZED now64()
)
ENGINE = ReplacingMergeTree
ORDER BY (test_name, input, probe_cc, probe_asn, time)
SETTINGS index_granularity = 4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.blocking_status
(
    `test_name` String,
    `input` String,
    `probe_cc` String,
    `probe_asn` Int32,
    `confirmed_perc` Float32,
    `pure_anomaly_perc` Float32,
    `accessible_perc` Float32,
    `cnt` Float32,
    `status` String,
    `old_status` String,
    `change` Float32,
    `stability` Float32,
    `update_time` DateTime64(0) MATERIALIZED now64()
)
ENGINE = ReplacingMergeTree
ORDER BY (test_name, input, probe_cc, probe_asn)
SETTINGS index_granularity = 4</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:citizenlab">citizenlab table</h4>
<div class="paragraph">
<p>Contains data from the <a href="https://github.com/citizenlab/test-lists">CitizenLab URL testing list repository</a>.</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.citizenlab
(
    `domain` String,
    `url` String,
    `cc` FixedString(32),
    `category_code` String
)
ENGINE = ReplacingMergeTree
ORDER BY (domain, url, cc, category_code)
SETTINGS index_granularity = 4</code></pre>
</div>
</div>
<div class="paragraph">
<p>Receive writes from <a href="#comp:citizenlab_test_lists_updater">Citizenlab test list updater</a></p>
</div>
</div>
<div class="sect3">
<h4 id="tbl:citizenlab_flip">citizenlab_flip table</h4>
<div class="paragraph">
<p>Temporary table. See <a href="#comp:citizenlab_test_lists_updater">Citizenlab test list updater</a></p>
</div>
</div>
<div class="sect3">
<h4 id="tbl:counters_asn_test_list">counters_asn_test_list table</h4>
<div class="paragraph">
<p>A <code>MATERIALIZED VIEW</code> table that, despite the name, is updated continuously by ClickHouse as new measurements are inserted in the <code>fastpath</code> table.</p>
</div>
<div class="paragraph">
<p>It contains statistics on the incoming measurement flow, grouped by week, <code>probe_cc</code>, <code>probe_asn</code> and <code>input</code>. It is used by <a href="#comp:prio">Prioritization</a>.</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE MATERIALIZED VIEW default.counters_asn_test_list
(
    `week` DateTime,
    `probe_cc` String,
    `probe_asn` UInt64,
    `input` String,
    `msmt_cnt` UInt64
)
ENGINE = SummingMergeTree
ORDER BY (probe_cc, probe_asn, input)
SETTINGS index_granularity = 8192 AS
SELECT
    toStartOfWeek(measurement_start_time) AS week,
    probe_cc,
    probe_asn,
    input,
    count() AS msmt_cnt
FROM default.fastpath
INNER JOIN default.citizenlab ON fastpath.input = citizenlab.url
WHERE (measurement_start_time &lt; now()) AND (measurement_start_time &gt; (now() - toIntervalDay(8))) AND (test_name = \'web_connectivity\')
GROUP BY week, probe_cc, probe_asn, input</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:counters_test_list">counters_test_list table</h4>
<div class="paragraph">
<p>Similar to <a href="#tbl:counters_asn_test_list">counters_asn_test_list table</a> - the main differences are that this table has daily granularity and does not discriminate by <code>probe_asn</code></p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE MATERIALIZED VIEW default.counters_test_list
(
    `day` DateTime,
    `probe_cc` String,
    `input` String,
    `msmt_cnt` UInt64
)
ENGINE = SummingMergeTree
PARTITION BY day
ORDER BY (probe_cc, input)
SETTINGS index_granularity = 8192 AS
SELECT
    toDate(measurement_start_time) AS day,
    probe_cc,
    input,
    count() AS msmt_cnt
FROM default.fastpath
INNER JOIN default.citizenlab ON fastpath.input = citizenlab.url
WHERE (measurement_start_time &lt; now()) AND (measurement_start_time &gt; (now() - toIntervalDay(8))) AND (test_name = \'web_connectivity\')
GROUP BY day, probe_cc, input</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:fastpath">fastpath table</h4>
<div class="paragraph">
<p>This table stores the output of the <a href="#comp:fastpath">Fastpath</a>. It is usually the largest table in the database and receives the largest amount of read and write traffic.</p>
</div>
<div class="paragraph">
<p>It is used by multiple entry points in the <a href="#comp:api">API</a>, primarily for measurement listing and presentation and by the <a href="#comp:mat">MAT</a></p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.fastpath
(
    `measurement_uid` String,
    `report_id` String,
    `input` String,
    `probe_cc` LowCardinality(String),
    `probe_asn` Int32,
    `test_name` LowCardinality(String),
    `test_start_time` DateTime,
    `measurement_start_time` DateTime,
    `filename` String,
    `scores` String,
    `platform` String,
    `anomaly` String,
    `confirmed` String,
    `msm_failure` String,
    `domain` String,
    `software_name` String,
    `software_version` String,
    `control_failure` String,
    `blocking_general` Float32,
    `is_ssl_expected` Int8,
    `page_len` Int32,
    `page_len_ratio` Float32,
    `server_cc` String,
    `server_asn` Int8,
    `server_as_name` String,
    `update_time` DateTime64(3) MATERIALIZED now64(),
    `test_version` String,
    `architecture` String,
    `engine_name` LowCardinality(String),
    `engine_version` String,
    `test_runtime` Float32,
    `blocking_type` String,
    `test_helper_address` LowCardinality(String),
    `test_helper_type` LowCardinality(String),
    INDEX fastpath_rid_idx report_id TYPE minmax GRANULARITY 1,
    INDEX measurement_uid_idx measurement_uid TYPE minmax GRANULARITY 8
)
ENGINE = ReplacingMergeTree(update_time)
ORDER BY (measurement_start_time, report_id, input, measurement_uid)
SETTINGS index_granularity = 8192</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#howto:fp_dedupe">Fastpath deduplication</a> for deduplicating the table records.</p>
</div>
</div>
<div class="sect3">
<h4 id="tbl:fingerprints_dns">fingerprints_dns table</h4>
<div class="paragraph">
<p>Stores measurement DNS fingerprints. The contents are used by the <a href="#comp:fastpath">Fastpath</a> to detect <code>confirmed</code> measurements.</p>
</div>
<div class="paragraph">
<p>It is updated by the <a href="#comp:fingerprint_updater">Fingerprint updater</a></p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.fingerprints_dns
(
    `name` String,
    `scope` Enum8(\'nat\' = 1, \'isp\' = 2, \'prod\' = 3, \'inst\' = 4, \'vbw\' = 5, \'fp\' = 6),
    `other_names` String,
    `location_found` String,
    `pattern_type` Enum8(\'full\' = 1, \'prefix\' = 2, \'contains\' = 3, \'regexp\' = 4),
    `pattern` String,
    `confidence_no_fp` UInt8,
    `expected_countries` String,
    `source` String,
    `exp_url` String,
    `notes` String
)
ENGINE = EmbeddedRocksDB
PRIMARY KEY name</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:fingerprints_dns_tmp">fingerprints_dns_tmp table</h4>
<div class="paragraph">
<p>Temporary table. See <a href="#comp:fingerprint_updater">Fingerprint updater</a></p>
</div>
</div>
<div class="sect3">
<h4 id="tbl:fingerprints_http">fingerprints_http table</h4>
<div class="paragraph">
<p>Stores measurement HTTP fingerprints. The contents are used by the <a href="#comp:fastpath">Fastpath</a> to detect <code>confirmed</code> measurements.</p>
</div>
<div class="paragraph">
<p>It is updated by the <a href="#comp:fingerprint_updater">Fingerprint updater</a></p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.fingerprints_http
(
    `name` String,
    `scope` Enum8(\'nat\' = 1, \'isp\' = 2, \'prod\' = 3, \'inst\' = 4, \'vbw\' = 5, \'fp\' = 6, \'injb\' = 7, \'prov\' = 8),
    `other_names` String,
    `location_found` String,
    `pattern_type` Enum8(\'full\' = 1, \'prefix\' = 2, \'contains\' = 3, \'regexp\' = 4),
    `pattern` String,
    `confidence_no_fp` UInt8,
    `expected_countries` String,
    `source` String,
    `exp_url` String,
    `notes` String
)
ENGINE = EmbeddedRocksDB
PRIMARY KEY name</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:fingerprints_http_tmp">fingerprints_http_tmp table</h4>
<div class="paragraph">
<p>Temporary table. See <a href="#comp:fingerprint_updater">Fingerprint updater</a></p>
</div>
</div>
<div class="sect3">
<h4 id="tbl:incidents">incidents table</h4>
<div class="paragraph">
<p>Stores incidents. See <a href="#comp:incidents">Incident management</a>.</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.incidents
(
    `update_time` DateTime DEFAULT now(),
    `start_time` DateTime DEFAULT now(),
    `end_time` Nullable(DateTime),
    `creator_account_id` FixedString(32),
    `reported_by` String,
    `id` String,
    `title` String,
    `text` String,
    `event_type` LowCardinality(String),
    `published` UInt8,
    `deleted` UInt8 DEFAULT 0,
    `CCs` Array(FixedString(2)),
    `ASNs` Array(UInt32),
    `domains` Array(String),
    `tags` Array(String),
    `links` Array(String),
    `test_names` Array(String),
    `short_description` String,
    `email_address` String,
    `create_time` DateTime DEFAULT now()
)
ENGINE = ReplacingMergeTree(update_time)
ORDER BY id
SETTINGS index_granularity = 1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:jsonl">jsonl table</h4>
<div class="paragraph">
<p>This table provides a method to look up measurements in <a href="#topic:jsonl">JSONL files</a> stored in Amazon S3 buckets.</p>
</div>
<div class="paragraph">
<p>It is written by the <a href="#uploader">API Measurement uploader</a> when <a href="#topic:postcans">Postcan files</a> and <a href="#topic:jsonl">JSONL files</a> just after measurements are uploaded to the bucket.</p>
</div>
<div class="paragraph">
<p>It is used by multiple entry points in the <a href="#comp:api">API</a>, primarily by <code>get_measurement_meta</code>.</p>
</div>
<div class="paragraph">
<p><a href="https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/api/ooniapi/measurements.py#L470" class="bare">https://github.com/ooni/backend/blob/0ec9fba0eb9c4c440dcb7456f2aab529561104ae/api/ooniapi/measurements.py#L470</a></p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.jsonl
(
    `report_id` String,
    `input` String,
    `s3path` String,
    `linenum` Int32,
    `measurement_uid` String,
    `date` Date,
    `source` String,
    `update_time` DateTime64(3) MATERIALIZED now64()
)
ENGINE = ReplacingMergeTree(update_time)
ORDER BY (report_id, input, measurement_uid)
SETTINGS index_granularity = 8192</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:msmt_feedback">msmt_feedback table</h4>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.msmt_feedback
(
    `measurement_uid` String,
    `account_id` String,
    `status` String,
    `update_time` DateTime64(3) MATERIALIZED now64(),
    `comment` String
)
ENGINE = ReplacingMergeTree
ORDER BY (measurement_uid, account_id)
SETTINGS index_granularity = 4</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:oonirun">oonirun table</h4>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.oonirun
(
    `ooni_run_link_id` UInt64,
    `descriptor_creation_time` DateTime64(3),
    `translation_creation_time` DateTime64(3),
    `creator_account_id` FixedString(32),
    `archived` UInt8 DEFAULT 0,
    `descriptor` String,
    `author` String,
    `name` String,
    `short_description` String,
    `icon` String
)
ENGINE = ReplacingMergeTree(translation_creation_time)
ORDER BY (ooni_run_link_id, descriptor_creation_time)
SETTINGS index_granularity = 1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:session_expunge">session_expunge table</h4>
<div class="paragraph">
<p>Used for authentication. It stores</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.session_expunge
(
    `account_id` FixedString(32),
    `threshold` DateTime DEFAULT now()
)
ENGINE = EmbeddedRocksDB
PRIMARY KEY account_id</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:obs_openvpn">obs_openvpn table</h4>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.obs_openvpn
(
    `anomaly` Int8,
    `bootstrap_time` Float32,
    `confirmed` Int8,
    `error` String,
    `failure` String,
    `input` String,
    `last_handshake_transaction_id` Int32,
    `measurement_start_time` DateTime,
    `measurement_uid` String,
    `minivpn_version` String,
    `obfs4_version` String,
    `obfuscation` String,
    `platform` String,
    `probe_asn` Int32,
    `probe_cc` String,
    `probe_network_name` String,
    `provider` String,
    `remote` String,
    `report_id` String,
    `resolver_asn` Int32,
    `resolver_ip` String,
    `resolver_network_name` String,
    `software_name` String,
    `software_version` String,
    `success` Int8,
    `success_handshake` Int8,
    `success_icmp` Int8,
    `success_urlgrab` Int8,
    `tcp_connect_status_success` Int8,
    `test_runtime` Float32,
    `test_start_time` DateTime,
    `transport` String
)
ENGINE = ReplacingMergeTree
ORDER BY (measurement_start_time, report_id, input)
SETTINGS index_granularity = 8</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:test_groups">test_groups table</h4>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.test_groups
(
    `test_name` String,
    `test_group` String
)
ENGINE = Join(ANY, LEFT, test_name)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:test_helper_instances">test_helper_instances table</h4>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.test_helper_instances
(
    `rdn` String,
    `dns_zone` String,
    `name` String,
    `provider` String,
    `region` String,
    `ipaddr` IPv4,
    `ipv6addr` IPv6,
    `draining_at` Nullable(DateTime(\'UTC\')),
    `sign` Int8,
    `destroyed_at` Nullable(DateTime(\'UTC\'))
)
ENGINE = CollapsingMergeTree(sign)
ORDER BY name
SETTINGS index_granularity = 8</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="tbl:url_priorities">url_priorities table</h4>
<div class="paragraph">
<p>TODO</p>
</div>
<div class="paragraph">
<p>Schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sql" data-lang="sql">CREATE TABLE default.url_priorities
(
    `sign` Int8,
    `category_code` String,
    `cc` String,
    `domain` String,
    `url` String,
    `priority` Int32
)
ENGINE = CollapsingMergeTree(sign)
ORDER BY (category_code, cc, domain, url, priority)
SETTINGS index_granularity = 1024</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="howto:fp_dedupe">Fastpath deduplication</h4>
<div class="paragraph">
<p>ClickHouse does not deduplicate all records deterministically for performance reasons. Full deduplication can be performed with the following command and it is often required after running the fastpath to reprocess old measurements. Deduplication is CPU and IO-intensive.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>time clickhouse-client -u admin --password admin --receive_timeout 9999 --send_timeout 9999 --query 'OPTIMIZE TABLE fastpath FINAL'</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_tips">Tips</h4>
<div class="paragraph">
<p>ClickHouse has a protection against table drops. Use this to allow dropping a table once. After use the flag file is automatically removed:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo touch '/var/lib/clickhouse/flags/force_drop_table' &amp;&amp; sudo chmod 666 '/var/lib/clickhouse/flags/force_drop_table'</pre>
</div>
</div>
<div class="paragraph">
<p>To monitor ClickHouse&#8217;s performance and table size growth there&#8217;s a <a href="#dash:clickhouse">dashboard</a> and the <a href="#nb:click_q">ClickHouse queries notebook</a></p>
</div>
<div class="paragraph">
<p>To investigate table and index sizes the following query is useful:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SELECT
    concat(database, '.', table) AS table,
    formatReadableSize(sum(bytes)) AS size,
    sum(rows) AS rows,
    max(modification_time) AS latest_modification,
    sum(bytes) AS bytes_size,
    any(engine) AS engine,
    formatReadableSize(sum(primary_key_bytes_in_memory)) AS primary_keys_size
FROM system.parts
WHERE active
GROUP BY database, table
ORDER BY bytes_size DESC</pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The system tables named <code>asynchronous_metric_log</code>, <code>query_log</code> and <code>query_thread_log</code> can be useful for debugging and performance optimization but grow over time and create additional I/O traffic. Possible workarounds are: drop old rows, or implement sampling writes that write only a percentage of the rows, disable logging for specific users or queries, or disable logging altogether.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
TODO
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>while true;
do
  v=$(clickhouse-client -q 'SELECT elapsed FROM system.processes order by elapsed desc limit 1')
  echo "clickhouse_longest_query_elapsed_seconds:$v|g" | nc -w 1 -u 127.0.0.1 8125</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>v=$(clickhouse-client -q 'SELECT count() FROM system.processes')
echo "clickhouse_running_queries_count:$v|g" | nc -w 1 -u 127.0.0.1 8125</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>clickhouse-client -q 'SELECT query FROM system.processes WHERE elapsed &gt; 10' | sed 's/\\n//g' | systemd-cat -t click-queries</pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>  sleep 1
done</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="topic:schema_changes">Continuous Deployment: Database schema changes</h3>
<div class="paragraph">
<p>The database schema required by the API is stored in <a href="https://github.com/ooni/backend/blob/master/api/tests/integ/clickhouse_1_schema.sql" class="bare">https://github.com/ooni/backend/blob/master/api/tests/integ/clickhouse_1_schema.sql</a></p>
</div>
<div class="paragraph">
<p>In a typical CD workflows it is possible to deploy database schema changes in a way that provides safety against outages and requires no downtimes.</p>
</div>
<div class="paragraph">
<p>Any component that can be deployed independently from others can be made responsible for creating and updating the tables it needs.
If multiple components access the same table it&#8217;s important to coordinate their code updates and deployements during schema changes.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
typical CD requires deployements to be performed incrementally to speed up and simplify rollouts.
It does not guarantees that package versions can be rolled forward or back by skipping intermediate versions.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To support such use-case more complex database scheme versioning would be required.
Due to hardware resource constraints and time constraints we need to be able to manually create new tables (especially on the test stage)
and perform analysis work, run performance and feature tests, troubleshooting etc.
As such, at this time the backend components are not checking the database schema against a stored "template" at install or start time.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
A starting point for more automated database versioning existed at <a href="https://github.com/ooni/backend/blob/master/api/database_upgrade_schema.py" class="bare">https://github.com/ooni/backend/blob/master/api/database_upgrade_schema.py</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
in future such check could be implemented and generate a warning to be enabled only on non-test CD stages.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
one way to make database changes at package install time is to use the <code>debian/postinst</code> script.
For example see <a href="https://github.com/ooni/backend/blob/master/fastpath/debian/postinst" class="bare">https://github.com/ooni/backend/blob/master/fastpath/debian/postinst</a>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
in writing SQL queries explicitly set the columns you need to read or write and access them by name: any new column will be ignored.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Some examples of database schema change workflows:</p>
</div>
<div class="sect3">
<h4 id="_adding_a_new_column_to_the_fastpath">Adding a new column to the fastpath</h4>
<div class="paragraph">
<p>The following workflow can be tweaked or simplified to add columns or tables to other components.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
multiple deployments or restarts should not trigger failures: always add columns using <code>ALTER TABLE &lt;name&gt; ADD COLUMN IF NOT EXISTS &lt;name&gt; &lt;other parameters&gt;</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The new column is added either manually or by deploying a new version of the fastpath package that adds the column at install or start time.
Ensure the rollout reaches all the CD stages.</p>
</div>
<div class="paragraph">
<p>Prepare, code-review, merge and deploy a new version of the fastpath that writes data to the new column.
Ensure the rollout reaches all the CD stages.</p>
</div>
<div class="paragraph">
<p>Verify the contents of the new column e.g. using a Jupyter Notebook</p>
</div>
<div class="paragraph">
<p>Prepare, code-review, merge and deploy a new version of the API that reads data from the new column.
Ensure the rollout reaches all the CD stages.</p>
</div>
<div class="paragraph">
<p>This workflow guarantees that the same schema and codebase has been testend on all stages before reaching production.</p>
</div>
</div>
<div class="sect3">
<h4 id="_renaming_a_column_or_table">Renaming a column or table</h4>
<div class="paragraph">
<p>This is a more complex workflow especially when multiple components access the same table or column.
It can also be used for changing a column type and other invasive changes.</p>
</div>
<div class="paragraph">
<p>For each of the following steps ensure the rollout reaches all the CD stages.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a new column or table.</p>
</li>
<li>
<p>Prepare, code-review, merge and deploy a new version of all the components that write data. Write all data to both the old and new column/table.</p>
</li>
<li>
<p>If required, run one-off queries that migrate existing data from the old column/table to the new one. Using <code>IF NOT EXISTS</code> can be useful.</p>
</li>
<li>
<p>Prepare, code-review, merge and deploy a new version of all the components that reads data. Update queries to only read from the new column/table.</p>
</li>
<li>
<p>Prepare, code-review, merge and deploy a new version of all the components that write data. Write data only to the new column/table.</p>
</li>
<li>
<p>Run one-off queries to delete the old column/table. Using <code>IF EXISTS</code> can be useful.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="topic:schema_check">Database schema check</h4>
<div class="paragraph">
<p>To compare the database schemas across backend hosts you can use:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>for hn in ams-pg-test backend-hel backend-fsn; do
  hn=${hn}.ooni.org
  echo $hn
  &gt; "schema_${hn}"
  for tbl in $(ssh $hn 'clickhouse-client -q "SHOW TABLES FROM default"' | grep -v inner_id ); do
    echo "  ${tbl}"
    ssh $hn "clickhouse-client -q \"SHOW CREATE TABLE default.${tbl}\"" | sed 's/\\n/\n/g' &gt;&gt; "schema_${hn}"
  done
done</pre>
</div>
</div>
<div class="paragraph">
<p>The generated files can be compared more easily using <code>meld</code>.</p>
</div>
<div class="paragraph">
<p>Also related: <a href="#comp:db_backup">Database backup tool</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="gh_actions">GitHub CI workflows</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are 5 main workflows that a run by GitHub Actions when new pull requests
are created or updated the backend repository.</p>
</div>
<div class="paragraph">
<p>They are configured using YAML files in the repository, plus secret keys and
other variables that can be edited on <a href="https://github.com/ooni/backend/settings/secrets/actions" class="bare">https://github.com/ooni/backend/settings/secrets/actions</a></p>
</div>
<div class="paragraph">
<p>The workflow files are:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>.github/workflows/build_deb_packages.yml
.github/workflows/docgen.yaml
.github/workflows/mypy.yml
.github/workflows/test_fastpath.yaml
.github/workflows/test_new_api.yml</pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
the workflows handle sensitive credentials. GitHub provides security features to prevent 3rd party
contributors from running CI actions through pull requests that might expose credentials.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="deb_build">Debian package build and publish</h3>
<div class="paragraph">
<p>Builds one or more .deb files from the backend repository and uploads them to Debian archives on S3.</p>
</div>
<div class="paragraph">
<p>The configuration file is:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>.github/workflows/build_deb_packages.yml</pre>
</div>
</div>
<div class="paragraph">
<p>The workflow installs the required dependencies as Debian packages and then fetches the <a href="#debops-ci">debops-ci tool</a> tool
from the <a href="https://github.com/ooni/sysadmin/tree/master/tools">sysadmin repository</a></p>
</div>
<div class="sect3">
<h4 id="debops-ci">debops-ci tool</h4>
<div class="paragraph">
<p>A Python script that automates package builds and CI/CD workflows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Detects <code>debian/</code> directories in the current repository. It inspects file changes tracked by git to identify
which projects are being modified.</p>
</li>
<li>
<p>Bumps up version numbers according to the <a href="#pkg_versioning">package versioning</a> criteria described below.</p>
</li>
<li>
<p>Builds Debian packages as needed.</p>
</li>
<li>
<p>Generates a Debian archive on S3. Uploads .deb files into it to make them available for deployment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is used in the CI worflow as:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>./debops-ci --show-commands ci --bucket-name ooni-internal-deb</pre>
</div>
</div>
<div class="sect4">
<h5 id="_details">Details</h5>
<div class="paragraph">
<p>The tool requires the following environment variables for automated ci runs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> in order to write to S3 buckets.</p>
</li>
<li>
<p><code>DEB_GPG_KEY</code> or <code>DEB_GPG_KEY_BASE64</code> to GPG-sign packages. The first variable can contain a PEM-encoded private key, while the second is base64-encoded.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other configuration parameters can be set from the command line. See the <code>-h</code> CLI option:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>usage:
Version 2023-10-20.1

Builds deb packages and uploads them to S3-compatible storage.
Works locally and on GitHub Actions and CircleCI
Detects which package[s] need to be built.
Support "release" and PR/testing archives.

scan              - scan the current repository for packages to be built
build             - locate and build packages
upload &lt;filename&gt; - upload one package to S3 or Bintray
ci                - detect CircleCI PRs, build and upload packages

Features:
 - Implement CI/CD workflow using package archives
 - Support adding packages to an existing S3 archive without requiring a
   local mirror
 - Support multiple packages in the same git repository
 - GPG signing
 - Support multiple architectures
 - Update changelogs automatically
 - Easy to debug
 - Phased updates (rolling deployments)

positional arguments:
  {upload,scan,ci,build}

options:
  -h, --help            show this help message and exit
  --bucket-name BUCKET_NAME
                        S3 bucket name
  --distro DISTRO       Debian distribution name
  --origin ORIGIN       Debian Origin name
  --arch ARCH           Debian architecture name
  --gpg-key-fp GPG_KEY_FP
                        GPG key fingerprint
  --show-commands       Show shell commands</code></pre>
</div>
</div>
<div class="paragraph">
<p>When running with the <code>ci</code> or <code>upload</code> commands, the tool creates the required directories and files on S3 to publish an archive
suitable for APT. It uploads any newly built package and then appends the package description to the <code>Packages</code> file.
It then generates a new <code>InRelease</code> file and adds a GPG signature at the bottom of the file.</p>
</div>
<div class="paragraph">
<p>See <a href="https://ooni-internal-deb.s3.eu-central-1.amazonaws.com/dists/unstable/main/binary-amd64/Packages">Packages</a> and <a href="https://ooni-internal-deb.s3.eu-central-1.amazonaws.com/dists/unstable/InRelease">InRelease</a> as examples.</p>
</div>
<div class="paragraph">
<p>The current OONI package archives are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://ooni-internal-deb.s3.eu-central-1.amazonaws.com/" class="bare">https://ooni-internal-deb.s3.eu-central-1.amazonaws.com/</a> - for internal use</p>
</li>
<li>
<p><a href="http://deb.ooni.org/" class="bare">http://deb.ooni.org/</a> also available as <a href="https://deb.ooni.org/" class="bare">https://deb.ooni.org/</a> - for publicly available packages</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Documentation on how to use the public archive: <a href="https://ooni.org/install/cli/ubuntu-debian" class="bare">https://ooni.org/install/cli/ubuntu-debian</a></p>
</div>
<div class="paragraph">
<p>The tool can also be used manually e.g. for debugging using actions <code>scan</code>, <code>build</code> and <code>upload</code>.</p>
</div>
<div class="paragraph">
<p>Unlike other CI/CD tools, debops-ci is designed to be stateless in order to run in ephemeral CI worker containers.
Due to limitations around transactional file uploads, a pair of lockfiles are used, named <code>.debrepos3.lock</code> and <code>.debrepos3.nolock</code></p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
If the github actions CI workflow for package build is restarted manually (that is, without git-pushing a new commit) debops-ci will refuse to overwrite the .deb package already present on S3. This is expected.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pkg_versioning">Package versioning</h4>
<div class="paragraph">
<p>The CI workflows builds Debian packages with the following versioning scheme:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>&lt;semver_version&gt;~pr&lt;pull_request_number&gt;-&lt;build_number&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>1.0.79~pr751-194</pre>
</div>
</div>
<div class="paragraph">
<p>This format has the benefits of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Providing a user-configured <a href="https://semver.org/">semantic versioning</a> part.</p>
</li>
<li>
<p>Automatically inserting a pull request number. This prevents version conflicts in case the first component has not been updated when opening a new pull request.</p>
</li>
<li>
<p>Automatically inserting an incremental build number. This allows incremental deployements of commits on testbeds.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is recommended to update the <code>debian/changelog</code> file in the first commit of each new pull request by adding a new semver number and a short changelog.
This helps keeping track of what changes are being deployed on test, integration and production servers.</p>
</div>
<div class="paragraph">
<p>Sometimes multiple pull requests for the same package are open at the same time and are rebased or merged in an order that is different from the pull request number.
In this case manually bumping up the semver number after each rebase is beneficial to ensure that the rollout is done incrementally.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pull request 751 builds a package versioned 1.0.79~pr751-14. The package is deployed on the testbed.</p>
</li>
<li>
<p>Pull request 752, opened later, is rebased on top of 751 and builds a package versioned 1.0.80~pr752-51. The package is deployed on the testbed.</p>
</li>
<li>
<p>The need to reorder the two PRs arises. PR 751 is now rebased on top of 752. The changelog file is manually updated to version 1.0.81
The CI now generates 1.0.81~pr751-43 and the packa</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the subchapter on the <a href="#deployer">deployer tool</a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="docgen">Code documentation generation</h3>
<div class="paragraph">
<p>The configuration lives at:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>.github/workflows/docgen.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>The workflow runs <code>./build_docs.py</code> to generate documentation from the Python files.
It is a script that extracts MarkDown and AsciiDoc docstrings from the codebase in the backend repository.
It also supports graphviz diagrams using kroki.io
It generates a set of HTML files that are published as GitHub pages as part of the CI workflow.</p>
</div>
<div class="paragraph">
<p>The outputs is lives at <a href="https://ooni.github.io/backend/" class="bare">https://ooni.github.io/backend/</a></p>
</div>
<div class="paragraph">
<p>At the time of writing it is superseeded by the present document.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mypy">Mypy</h3>
<div class="paragraph">
<p>The configuration lives at:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>.github/workflows/mypy.yml</pre>
</div>
</div>
<div class="paragraph">
<p>It runs mypy to check Python typing and makes the CI run fail if errors are detected.</p>
</div>
</div>
<div class="sect2">
<h3 id="_fastpath_test">Fastpath test</h3>
<div class="paragraph">
<p>The configuration lives at:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>.github/workflows/test_fastpath.yaml</pre>
</div>
</div>
<div class="paragraph">
<p>Runs the following unit and functional tests against the fastpath:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>fastpath/tests/test_functional.py
fastpath/tests/test_functional_nodb.py
fastpath/tests/test_unit.py</pre>
</div>
</div>
<div class="paragraph">
<p>These are not end-to-end tests for the backend e.g. the API is not being tested.</p>
</div>
<div class="paragraph">
<p>The CI action creates a dedicated container and installs the required dependencies as Debian packages.
It provides a code coverage report in HTML format.</p>
</div>
</div>
<div class="sect2">
<h3 id="e2e-test">API end-to-end test</h3>
<div class="paragraph">
<p>The configuration lives at:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>.github/workflows/test_new_api.yml</pre>
</div>
</div>
<div class="paragraph">
<p>This CI action performs the most comprehensive test of the backed. In sequence:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creates a dedicated container and installs the required dependencies as Debian packages.</p>
</li>
<li>
<p>It starts a ClickHouse container</p>
</li>
<li>
<p>Creates the required database tables, see <a href="https://github.com/ooni/backend/blob/master/api/tests/integ/clickhouse_1_schema.sql" class="bare">https://github.com/ooni/backend/blob/master/api/tests/integ/clickhouse_1_schema.sql</a></p>
</li>
<li>
<p>Initializes the database tables with test data, see <a href="https://github.com/ooni/backend/blob/master/api/tests/integ/clickhouse_2_fixtures.sql" class="bare">https://github.com/ooni/backend/blob/master/api/tests/integ/clickhouse_2_fixtures.sql</a></p>
</li>
<li>
<p>Runs the fastpath against data from a bucket on S3 in order to populate the <code>fastpath</code> table with real data. The measurements come from both:</p>
<div class="ulist">
<ul>
<li>
<p>A fixed time range in the past</p>
</li>
<li>
<p>Recent data</p>
</li>
</ul>
</div>
</li>
<li>
<p>It runs unit, functional and integration tests against the API. Integration tests require the API to run queries against multiple tables in ClickHouse.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
the presence of recent data makes the content of the <code>fastpath</code> database table non deterministic between CI runs.
This is necessary to perform integration tests against API entry points that need fresh data.
To prevent flaky CI runs write integration tests with to handle variable data. E.g. use broad thresholds like asserting that the number of measurements collected in a day is more than 1.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
prefer unit tests where possible
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
To implement precise functional tests, mock out the database.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_miscellaneous_scripts_running_on_fsn_or_ams_pg_test">Miscellaneous scripts running on FSN or ams-pg-test</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_incident_response">Incident response</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_preparation">Preparation</h3>
<div class="paragraph">
<p>Review <a href="#topic:alerting">Alerting</a> and check <a href="#topic:dashboards">Grafana dashboards</a></p>
</div>
<div class="paragraph">
<p>On Android devices the following apps can be used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Slack app with audible notifications from the #ooni-bots channel</p>
</li>
<li>
<p><a href="#tool:grafana">Grafana</a> viewer <a href="https://play.google.com/store/apps/details?id=it.ksol.grafanaview" class="bare">https://play.google.com/store/apps/details?id=it.ksol.grafanaview</a></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="ntfy">Redundant notifications</h3>
<div class="paragraph">
<p>If needed, a secondary channel for alert notification can be set up using <a href="https://ntfy.sh/" class="bare">https://ntfy.sh/</a></p>
</div>
<div class="paragraph">
<p>Ntfy can host a push notification topic for free.</p>
</div>
<div class="paragraph">
<p>For example <a href="https://ntfy.sh/ooni-7aGhaS" class="bare">https://ntfy.sh/ooni-7aGhaS</a> is currently being used to notify the outcome of CI
runs from <a href="https://github.com/ooni/backend/blob/master/.github/workflows/test_new_api.yml" class="bare">https://github.com/ooni/backend/blob/master/.github/workflows/test_new_api.yml</a></p>
</div>
<div class="paragraph">
<p>An Android app is available: <a href="https://f-droid.org/en/packages/io.heckel.ntfy/" class="bare">https://f-droid.org/en/packages/io.heckel.ntfy/</a></p>
</div>
<div class="paragraph">
<p><a href="#tool:grafana">Grafana</a> can be configured to send alerts to ntfy.sh using a webhook.</p>
</div>
<div class="paragraph">
<p>TODO: example of incident response</p>
</div>
</div>
<div class="sect2">
<h3 id="_investigating_test_helper_rotation">Investigating test helper rotation</h3>
<div class="paragraph">
<p><a href="https://grafana.ooni.org/d/Dn1R7QEnz/test-helpers?orgId=1&amp;from=now-15d&amp;to=now" class="bare">https://grafana.ooni.org/d/Dn1R7QEnz/test-helpers?orgId=1&amp;from=now-15d&amp;to=now</a></p>
</div>
<div class="paragraph">
<p>A summary of the live and last rotated test helper can be obtained with:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>SELECT rdn, dns_zone, name, region, draining_at FROM test_helper_instances ORDER BY name DESC LIMIT 8</pre>
</div>
</div>
<div class="paragraph">
<p>Check the next test helper run:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>systemctl status ooni-rotation.timer</pre>
</div>
</div>
<div class="paragraph">
<p>Check the dashboards:
<a href="https://jupyter.ooni.org/notebooks/notebooks/2022%20%5Bfederico%5D%20new%20test%20helper%20results.ipynb" class="bare">https://jupyter.ooni.org/notebooks/notebooks/2022%20%5Bfederico%5D%20new%20test%20helper%20results.ipynb</a></p>
</div>
<div class="paragraph">
<p><a href="https://jupyter.ooni.org/notebooks/2022%20%5Bfederico%5D%20new%20test%20helpers.ipynb" class="bare">https://jupyter.ooni.org/notebooks/2022%20%5Bfederico%5D%20new%20test%20helpers.ipynb</a></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2023-11-10 18:36:33 +0100
</div>
</div>
</body>
</html>